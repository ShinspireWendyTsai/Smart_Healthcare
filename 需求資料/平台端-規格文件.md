# 全方位智慧貼身照護平台－平台端規格文件

## 1. 文件控管

| 項目 | 內容 |
|---|---|
| 文件名稱 | 全方位智慧貼身照護平台－平台端規格文件 |
| 文件版本 | v1.0 |
| 文件日期 | 2026-02-26 |
| 整理來源 | 需求資料/系統規格文件.md（SA+SD 整併版） |
| 適用範圍 | 3.平台端 前端頁面與 ACT-P 管理 API/資料模型 |

---

## 2. 需求規格（SA）

### 2.1 角色與權責

| 角色代碼 | 角色名稱 | 平台端關聯責任 |
|---|---|---|
| ACT-P | 平台管理者 | 機構審核、會員治理、客服分派、角色權限、操作稽核 |
| ACT-O | 機構管理者 | 受平台治理並提供營運資料 |
| ACT-C | 客戶端使用者 | 受平台規則治理與客服互動 |

### 2.2 功能需求（FR-P）

- FR-P-001：機構審核與啟停管理。
- FR-P-002：會員管理與帳號狀態治理。
- FR-P-003：全平台訂單查詢、異常處理、退款審核。
- FR-P-004：服務類別與服務主檔管理。
- FR-P-005：平台公告與投放對象管理。
- FR-P-006：客服單分派、時效追蹤、統計。
- FR-P-007：平台管理者、角色、權限治理。
- FR-P-008：操作日誌查詢與異常行為監控。

### 2.3 Use Case（平台端）

| UC 編號 | 名稱 | 關聯需求 |
|---|---|---|
| UC-P-01 | 機構審核與啟用 | FR-P-001 |
| UC-P-02 | 客服單分派與結案 | FR-P-006 |
| UC-P-03 | 角色權限設定 | FR-P-007 |

#### UC-P-02 客服單分派與結案

- 前置：客服單狀態為 `open`。
- 主流程：檢視工單 → 指派人員（`in_progress`）→ 回覆處理 → `resolved` → 提單者確認 `closed`。
- 例外：超過 SLA 未完成觸發逾期告警。
- 後置：完整保留處理歷程與稽核軌跡。

### 2.4 業務規則（平台端關聯）

- BR-ORD-003：退款申請需由平台端審核並保留意見。
- BR-TIC-001：客服單需具備優先級。
- BR-TIC-002：客服單狀態異動需記錄操作人、時間、原因。
- BR-AUD-001：管理端 C/U/D 必寫操作日誌。

### 2.5 狀態模型（平台端關聯）

#### 訂單狀態（含退款治理）

`pending_payment` → `paid` → `processing` → `completed`，並支援 `refund_pending` → `refunded` 或回復履約狀態。

#### 客服單狀態

`open` → `in_progress` → `resolved` → `closed`（可重開）。

### 2.6 權限摘要（ACT-P）

| 模組 | 權限 |
|---|---|
| 個案綁定 | R |
| 服務與購物車 | C/R/U/D |
| 訂單管理 | C/R/U/D（全平台） |
| 公告 | C/R/U/D（平台） |
| 通訊 | R（監管） |
| 客服單 | C/R/U/D（分派與治理） |
| 角色權限 | C/R/U/D（全平台） |
| 操作日誌 | R（全平台） |

### 2.7 非功能需求（平台端關聯）

- NFR-001：列表 API P95 < 2 秒。
- NFR-010：管理端 RBAC 權限檢核。
- NFR-011：敏感資料遮罩與加密。
- NFR-012：重要操作全量記錄於 audit_log。
- NFR-030：三端模組化維護。

### 2.8 驗收條件（AT-P）

- AT-P-01：可完成機構審核與啟用/停用。
- AT-P-02：客服單可完成分派、處理、結案，逾時可告警。
- AT-P-03：角色權限調整即時影響選單與 API 存取。

### 2.9 頁面盤點（平台端）

- index.html
- organizations.html
- org-review.html
- members.html
- orders.html
- categories.html
- services.html
- announcements.html
- tickets.html
- admins.html
- roles.html
- logs.html

---

## 3. 系統設計（SD）

### 3.1 設計目標

1. 建立全平台治理能力（機構、客服、權限、稽核）。
2. 以 RBAC + 稽核確保管理操作可控、可追溯。
3. 對高風險流程（退款/客服狀態）採一致狀態管理。

### 3.2 架構定位

- Presentation：3.平台端
- API Layer：`/api/v1` + JWT + RBAC
- Domain Services：Governance、Identity & Access、Ticket、Order、Catalog
- Integration：Payment / Notification Adapter
- Data：MySQL 8（可選 Redis）

### 3.3 模組設計（平台端主關聯）

| 模組 | 職責 | 主要資料表 |
|---|---|---|
| Governance | 機構/會員治理、操作日誌、異常檢核 | organizations、audit_logs |
| Identity & Access | 角色權限維護與授權檢核 | roles、permissions、role_permissions、user_roles |
| Ticket | 工單分派、狀態流轉、SLA 追蹤 | tickets、ticket_replies |
| Order/Catalog/Announcement | 訂單治理、主資料、公告投放 | orders、order_items、payment_events、service_categories、services、announcements |

### 3.4 API 規格（平台端）

#### 共通規範

- Base URL：`/api/v1`
- 認證：Bearer JWT
- 格式：application/json
- 追蹤：x-request-id

#### 核心 API

| API | 方法 | 權限 | 用途 |
|---|---|---|---|
| /api/v1/tickets/{id}/assign | PATCH | ACT-P | 指派客服單 |
| /api/v1/tickets/{id}/status | PATCH | ACT-P | 更新客服單狀態 |
| /api/v1/admin/roles | CRUD | ACT-P | 角色權限管理 |
| /api/v1/admin/logs | GET | ACT-P | 操作日誌查詢 |
| /api/v1/orders | GET | ACT-C/ACT-O/ACT-P | 全平台訂單查詢 |

### 3.5 權限模型與安全稽核

#### RBAC 模型

1. 使用者可持有多角色（user_roles）。
2. 角色可包含多權限（role_permissions）。
3. 權限粒度：`module_code + action_code`。
4. 管理端 API 一律經 RBAC 中介層檢核。

#### 權限碼建議

| module_code | action_code |
|---|---|
| ORG_REVIEW | READ/APPROVE/REJECT |
| ORDER | READ/UPDATE/REFUND |
| TICKET | READ/ASSIGN/UPDATE/CLOSE |
| ROLE | READ/CREATE/UPDATE/DELETE |
| AUDIT_LOG | READ |

#### 安全與稽核控制

- JWT 驗證 + Refresh Token。
- 外部回調：簽章驗證 + IP 白名單 + 重放防護。
- 交易防重：`idempotency_key`、`provider_txn_id` 唯一索引。
- 管理端 C/U/D 必寫 audit_logs。

### 3.6 關鍵流程序列

#### 客服單流程（UC-P-02）

1. 建單：建立 tickets。
2. 指派：設定 assignee，狀態轉 `in_progress`。
3. 回覆：寫 ticket_replies（含內外部備註）。
4. 結案：狀態轉 `resolved/closed` 並寫 audit_logs。

#### 訂單付款治理關聯流程

1. 接收金流回調並寫 payment_events。
2. 更新 orders 狀態並寫 order_status_logs。
3. 平台端依異常狀態執行治理（如退款審核）。

### 3.7 非功能設計（實作向）

- 監控指標：API 成功率、P95、付款成功率、SLA 達成率。
- 日誌分級：ERROR/WARN/INFO。
- 高風險管理操作需完整追蹤 request_id。
- 發版需執行 migration 審核與 schema drift 檢查。

### 3.8 設計追蹤矩陣（SD-RTM）

| FR | 模組 | 主要 API | 主要資料表 |
|---|---|---|---|
| FR-P-001 | Governance | /admin/organizations/review（SD 實作） | organizations、audit_logs |
| FR-P-006 | Ticket | /tickets、/tickets/{id}/assign、/tickets/{id}/status | tickets、ticket_replies |
| FR-P-007 | Identity & Access | /admin/roles | roles、permissions、role_permissions |
| FR-P-008 | Governance | /admin/logs | audit_logs |

---

## 4. SA/SD 整合追溯

| 需求 | Use Case | 設計模組 | 關聯 API | 驗收 |
|---|---|---|---|---|
| FR-P-001 | UC-P-01 | Governance | /admin/organizations/review（SD 實作） | AT-P-01 |
| FR-P-006 | UC-P-02 | Ticket | /tickets/{id}/assign、/tickets/{id}/status | AT-P-02 |
| FR-P-007 | UC-P-03 | Identity & Access | /admin/roles | AT-P-03 |
| FR-P-008 | （治理流程） | Governance | /admin/logs | （持續稽核） |
