# 全方位智慧貼身照護平台－系統規格與設計整併文件（SA+SD）

## 1. 文件控管

| 項目 | 內容 |
|---|---|
| 文件名稱 | 全方位智慧貼身照護平台－系統分析規格書 |
| 文件代碼 | SA-SMART-HEALTHCARE-001 |
| 文件版本 | v2.0 |
| 文件日期 | 2026-02-26 |
| 適用範圍 | 客戶端、機構端、平台端 |
| 主要依據 | 需求資料/系統藍圖.md、現有前端原型頁面 |

### 1.1 修訂紀錄

| 版本 | 日期 | 修訂內容 |
|---|---|---|
| v1.0 | 2026-02-26 | 初版功能規格 |
| v2.0 | 2026-02-26 | 轉為系統分析格式（Use Case、資料字典、狀態機、追蹤矩陣） |

---

## 2. 分析目的與方法

### 2.1 分析目的

本文件目的為建立可直接銜接系統設計（SD）與開發實作的分析規格，明確定義：

1. 業務流程與系統邊界。
2. 角色、權限與功能責任。
3. 主要 Use Case 與例外流程。
4. 邏輯資料模型與資料字典。
5. 模組、頁面、API、資料實體之追蹤關係。

### 2.2 分析方法

- 文件分析：依系統藍圖盤點需求。
- 原型比對：依三端現有頁面映射功能模組。
- 需求結構化：以 FR / UC / BR / NFR 編碼。
- 可追溯分析：建立需求追蹤矩陣（RTM）。

---

## 3. 系統邊界與上下游

### 3.1 系統邊界（System Boundary）

本系統提供三端入口：

- 客戶端：個案、家屬之服務使用與互動。
- 機構端：合作機構日常營運與個案服務管理。
- 平台端：全平台治理、審核、權限與稽核。

### 3.2 外部系統（External Systems）

| 外部系統 | 目的 | 串接方向 |
|---|---|---|
| 簡訊服務（OTP） | 手機驗證碼發送 | 本系統 → 簡訊供應商 |
| 金流服務 | 訂單付款、退款 | 本系統 ↔ 金流平台 |
| 通知服務 | 推播訊息通知 | 本系統 → 推播通道 |
| 郵件服務 | 系統通知/客服回覆 | 本系統 → 郵件服務 |

### 3.3 本期範圍與排除範圍

**本期範圍（In Scope）**

- 三端主要功能流程與資料處理。
- 訂單、客服單、公告、角色權限與操作紀錄。

**排除範圍（Out of Scope）**

- AI 推薦/預測模型。
- 醫療設備即時資料串流。
- 完整多語系翻譯治理流程。

---

## 4. 現況（As-Is）與目標（To-Be）分析

> 註：As-Is 以現有藍圖與原型狀態推定，用於分析差距；最終以需求會議確認為準。

| 面向 | As-Is（目前） | To-Be（目標） |
|---|---|---|
| 入口與角色 | 三端入口已分離，功能描述明確 | 建立統一帳號授權模型與角色授權控管 |
| 訂單流程 | 已有前端流程頁面 | 補齊狀態機、金流回寫、異常補償 |
| 綁定流程 | 有綁定/審核頁面與需求敘述 | 建立完整 OTP、審核、失效與重送規則 |
| 客服流程 | 已有客服單與詳情頁 | 建立 SLA、指派、升級與追蹤機制 |
| 稽核治理 | 平台端有 logs 頁面 | 落實敏感操作全量記錄與查核 |

---

## 5. 角色與權責分析

| 角色代碼 | 角色名稱 | 說明 | 核心責任 |
|---|---|---|---|
| ACT-C | 客戶端使用者（個案/家屬） | 服務使用者 | 綁定、下單、查單、通訊、提單 |
| ACT-O | 機構管理者 | 合作機構人員 | 個案審核、公告、通訊、分潤查詢 |
| ACT-P | 平台管理者 | 系統最高管理權限 | 機構審核、主資料治理、客服稽核、權限與日誌 |
| ACT-SYS | 外部服務 | 系統整合角色 | OTP、金流、推播回調 |

---

## 6. 需求分解（FR）

### 6.1 客戶端需求

- FR-C-001：邀請碼綁定與 OTP 驗證。
- FR-C-002：關懷者綁定與解除。
- FR-C-003：服務瀏覽、搜尋、篩選、排序。
- FR-C-004：購物車、結帳、付款、訂單追蹤。
- FR-C-005：通知中心（未讀、已讀、刪除、跳轉）。
- FR-C-006：即時通訊與訊息查詢。
- FR-C-007：客服提單、查詢、回覆通知。

### 6.2 機構端需求

- FR-O-001：個案綁定邀請碼管理與審核。
- FR-O-002：個案主檔與服務歷程查詢。
- FR-O-003：訂單與分潤報表查詢。
- FR-O-004：機構公告管理與閱讀統計。
- FR-O-005：機構通訊管理（單聊/群發）。
- FR-O-006：機構管理者與角色管理。

### 6.3 平台端需求

- FR-P-001：機構審核與啟停管理。
- FR-P-002：會員管理與帳號狀態治理。
- FR-P-003：全平台訂單查詢、異常處理、退款審核。
- FR-P-004：服務類別與服務主檔管理。
- FR-P-005：平台公告與投放對象管理。
- FR-P-006：客服單分派、時效追蹤、統計。
- FR-P-007：平台管理者、角色、權限治理。
- FR-P-008：操作日誌查詢與異常行為監控。

---

## 7. Use Case 分析

### 7.1 Use Case 清單

| UC 編號 | 名稱 | 主要角色 | 關聯需求 |
|---|---|---|---|
| UC-C-01 | 個案帳號綁定 | ACT-C | FR-C-001 |
| UC-C-02 | 建立訂單與付款 | ACT-C | FR-C-004 |
| UC-C-03 | 提交客服單 | ACT-C | FR-C-007 |
| UC-O-01 | 審核個案綁定申請 | ACT-O | FR-O-001 |
| UC-O-02 | 查詢訂單與分潤 | ACT-O | FR-O-003 |
| UC-P-01 | 機構審核與啟用 | ACT-P | FR-P-001 |
| UC-P-02 | 客服單分派與結案 | ACT-P | FR-P-006 |
| UC-P-03 | 角色權限設定 | ACT-P | FR-P-007 |

### 7.2 Use Case 詳細規格

#### UC-C-01 個案帳號綁定

- 目標：建立客戶端使用者與個案的合法綁定關係。
- 前置條件：使用者已登入；邀請碼存在且有效。
- 觸發條件：使用者送出邀請碼。
- 主要流程：
  1. 系統驗證邀請碼有效性。
  2. 系統發送 OTP 至綁定手機。
  3. 使用者輸入 OTP。
  4. 系統驗證成功，建立綁定記錄。
  5. 系統通知機構端與個案關係人。
- 例外流程：
  - E1：邀請碼無效/過期，回傳錯誤並要求重新輸入。
  - E2：OTP 錯誤超過上限，暫時鎖定並要求重送。
- 後置條件：綁定狀態為 `active`，寫入稽核日誌。
- 關聯頁面：1.客戶端/caregiver-binding.html

#### UC-C-02 建立訂單與付款

- 目標：完成服務訂購與付款。
- 前置條件：商品已上架；購物車非空。
- 觸發條件：使用者於結帳頁按下送出訂單。
- 主要流程：
  1. 系統檢核商品可售、價格、折扣。
  2. 建立訂單（狀態：`pending_payment`）。
  3. 導向金流交易並取得結果。
  4. 付款成功後更新為 `paid`。
  5. 產生通知並同步機構端查詢。
- 例外流程：
  - E1：付款失敗，訂單保留於 `pending_payment`。
  - E2：逾時未付款，系統排程轉為 `cancelled`。
- 後置條件：可由客戶端與機構端追蹤訂單狀態。
- 關聯頁面：1.客戶端/checkout.html、1.客戶端/orders.html

#### UC-O-01 審核個案綁定申請

- 目標：機構端審核個案綁定請求。
- 前置條件：存在待審核綁定申請。
- 觸發條件：機構管理者於審核頁執行核准或駁回。
- 主要流程：
  1. 顯示待審核申請明細。
  2. 管理者核准或駁回。
  3. 系統更新狀態並記錄審核者與時間。
  4. 系統通知申請者審核結果。
- 例外流程：
  - E1：資料不足無法審核，要求補件。
- 後置條件：申請狀態由 `pending` 轉為 `approved` / `rejected`。
- 關聯頁面：2.機構端/member-review.html

#### UC-P-02 客服單分派與結案

- 目標：平台端完成客服單指派、處理、結案。
- 前置條件：已建立客服單且狀態為 `open`。
- 觸發條件：客服主管於平台端進行分派。
- 主要流程：
  1. 平台管理者檢視工單內容與優先級。
  2. 指派處理人員，狀態轉為 `in_progress`。
  3. 處理過程可補充回覆與內部備註。
  4. 完成處理，狀態轉為 `resolved`。
  5. 由提單者確認後轉 `closed`。
- 例外流程：
  - E1：超過 SLA 時間仍未完成，觸發逾期告警。
- 後置條件：完整保留處理歷程與稽核軌跡。
- 關聯頁面：3.平台端/tickets.html

---

## 8. 業務規則（BR）

- BR-ACC-001：OTP 單次有效期 5 分鐘；連續錯誤 5 次鎖定 15 分鐘。
- BR-ACC-002：邀請碼需具有效期限與使用次數上限。
- BR-ORD-001：訂單金額以建立訂單當下的價格與折扣快照為準。
- BR-ORD-002：訂單一旦進入 `processing` 不可由客戶端直接取消。
- BR-ORD-003：退款申請需由平台端審核，保留審核意見。
- BR-TIC-001：客服單需具備優先級（low/medium/high/urgent）。
- BR-TIC-002：客服單所有狀態變更需保留操作人、時間與原因。
- BR-AUD-001：管理端新增/編輯/刪除操作必須寫入操作日誌。

---

## 9. 狀態模型分析

### 9.1 訂單狀態機

| 目前狀態 | 事件 | 下一狀態 | 說明 |
|---|---|---|---|
| pending_payment | 付款成功 | paid | 金流回調成功 |
| pending_payment | 付款逾時 | cancelled | 逾時自動取消 |
| paid | 開始履約 | processing | 機構開始處理 |
| processing | 完成履約 | completed | 服務完成 |
| paid/processing | 申請退款 | refund_pending | 待平台審核 |
| refund_pending | 退款核准 | refunded | 金流退款完成 |
| refund_pending | 退款駁回 | processing/completed | 依實際履約狀態回復 |

### 9.2 客服單狀態機

| 目前狀態 | 事件 | 下一狀態 |
|---|---|---|
| open | 指派處理人員 | in_progress |
| in_progress | 處理完成 | resolved |
| resolved | 使用者確認 | closed |
| in_progress/resolved | 重新開啟 | in_progress |

### 9.3 綁定申請狀態

| 狀態 | 說明 |
|---|---|
| pending | 待審核 |
| approved | 審核通過 |
| rejected | 審核駁回 |
| expired | 逾時失效 |

---

## 10. 邏輯資料模型與資料字典

### 10.1 主要實體關聯（Logical ER）

1. `Organization` 1:N `OrgAdmin`
2. `Organization` 1:N `MemberBinding`
3. `User` 1:N `Order`
4. `Order` 1:N `OrderItem`
5. `ServiceCategory` 1:N `Service`
6. `Service` 1:N `OrderItem`
7. `Ticket` 1:N `TicketReply`
8. `Role` N:M `Permission`（透過 `RolePermission`）
9. `User` 1:N `AuditLog`

### 10.2 資料字典（核心表）

#### A. user

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| id | bigint | Y | 使用者主鍵 |
| role_type | varchar(20) | Y | member/org_admin/platform_admin |
| name | varchar(100) | Y | 姓名 |
| phone | varchar(20) | Y | 手機（唯一） |
| email | varchar(255) | N | 電子郵件 |
| status | varchar(20) | Y | active/inactive/locked |
| created_at | datetime | Y | 建立時間 |

#### B. organization

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| id | bigint | Y | 機構主鍵 |
| name | varchar(200) | Y | 機構名稱 |
| tax_id | varchar(20) | Y | 統一編號 |
| owner_name | varchar(100) | Y | 負責人 |
| contact_phone | varchar(20) | Y | 聯絡電話 |
| status | varchar(20) | Y | pending/active/inactive |
| revenue_ratio | decimal(5,2) | Y | 分潤比例 |

#### C. service

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| id | bigint | Y | 服務主鍵 |
| category_id | bigint | Y | 服務類別 |
| name | varchar(200) | Y | 服務名稱 |
| description | text | N | 服務說明 |
| base_price | decimal(12,2) | Y | 原價 |
| sale_price | decimal(12,2) | N | 促銷價 |
| status | varchar(20) | Y | on_shelf/off_shelf |

#### D. order / order_item

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| order.id | bigint | Y | 訂單主鍵 |
| order.member_id | bigint | Y | 下單會員 |
| order.org_id | bigint | Y | 所屬機構 |
| order.order_status | varchar(30) | Y | 訂單狀態 |
| order.payment_status | varchar(30) | Y | 付款狀態 |
| order.total_amount | decimal(12,2) | Y | 訂單總金額 |
| order_item.order_id | bigint | Y | 關聯訂單 |
| order_item.service_id | bigint | Y | 關聯服務 |
| order_item.qty | int | Y | 數量 |
| order_item.unit_price | decimal(12,2) | Y | 單價快照 |

#### E. ticket

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| id | bigint | Y | 客服單主鍵 |
| source_type | varchar(20) | Y | client/org |
| creator_id | bigint | Y | 建立者 |
| type | varchar(50) | Y | 問題類型 |
| priority | varchar(20) | Y | low/medium/high/urgent |
| status | varchar(20) | Y | open/in_progress/resolved/closed |
| assignee_id | bigint | N | 指派人員 |
| created_at | datetime | Y | 建立時間 |

#### F. audit_log

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| id | bigint | Y | 日誌主鍵 |
| operator_id | bigint | Y | 操作者 |
| module | varchar(50) | Y | 功能模組 |
| action | varchar(20) | Y | create/update/delete/login |
| target_id | varchar(100) | N | 目標資料鍵值 |
| before_json | json | N | 異動前快照 |
| after_json | json | N | 異動後快照 |
| ip | varchar(50) | Y | 來源 IP |
| created_at | datetime | Y | 操作時間 |

---

## 11. 介面與整合規格（分析層）

### 11.1 頁面模組對照

| 端別 | 頁面 | 模組 |
|---|---|---|
| 客戶端 | categories.html / service-detail.html | 服務瀏覽與下單 |
| 客戶端 | checkout.html / orders.html | 訂單交易 |
| 客戶端 | messages.html / chat.html | 訊息與通訊 |
| 機構端 | member-review.html / members.html | 綁定審核與個案管理 |
| 機構端 | orders.html | 分潤與訂單查詢 |
| 平台端 | organizations.html / org-review.html | 機構治理 |
| 平台端 | tickets.html | 客服單治理 |
| 平台端 | roles.html / logs.html | 權限與稽核 |

### 11.2 API 草案（供 SD 階段細化）

| API | 方法 | 說明 | 權限 |
|---|---|---|---|
| /api/v1/bindings/request-otp | POST | 送出綁定 OTP | ACT-C |
| /api/v1/bindings/verify | POST | 驗證 OTP 並建立綁定 | ACT-C |
| /api/v1/services | GET | 服務查詢（關鍵字/篩選） | Public/ACT-C |
| /api/v1/orders | POST | 建立訂單 | ACT-C |
| /api/v1/orders/{id}/pay-callback | POST | 金流回寫 | ACT-SYS |
| /api/v1/orders | GET | 訂單查詢 | ACT-C/ACT-O/ACT-P |
| /api/v1/member-bindings/{id}/review | PATCH | 綁定審核 | ACT-O |
| /api/v1/tickets | POST | 建立客服單 | ACT-C/ACT-O |
| /api/v1/tickets/{id}/assign | PATCH | 指派客服單 | ACT-P |
| /api/v1/tickets/{id}/status | PATCH | 更新客服單狀態 | ACT-P |
| /api/v1/admin/roles | CRUD | 角色權限管理 | ACT-P |
| /api/v1/admin/logs | GET | 操作日誌查詢 | ACT-P |

---

## 12. 權限矩陣（摘要）

| 模組 | 客戶端 ACT-C | 機構端 ACT-O | 平台端 ACT-P |
|---|---|---|---|
| 個案綁定 | C/R/U | R（審核） | R |
| 服務與購物車 | C/R/U | R | C/R/U/D |
| 訂單管理 | C/R（本人） | R（所屬機構） | C/R/U/D（全平台） |
| 公告管理 | R | C/R/U/D（機構） | C/R/U/D（平台） |
| 通訊功能 | C/R/U | C/R/U | R（監管） |
| 客服單 | C/R | C/R | C/R/U/D（分派與治理） |
| 角色權限 | - | C/R/U（機構內） | C/R/U/D（全平台） |
| 操作日誌 | - | R（機構範圍） | R（全平台） |

---

## 13. 非功能需求（NFR）

### 13.1 效能

- NFR-001：列表型 API，P95 回應時間 < 2 秒。
- NFR-002：下單與付款回寫具冪等（Idempotency）控制。

### 13.2 安全

- NFR-010：管理端需 RBAC 權限檢核。
- NFR-011：敏感資料（付款資訊、個資）需遮罩與加密。
- NFR-012：重要操作全量記錄於 audit_log。

### 13.3 可用性

- NFR-020：支援桌機與手機版操作。
- NFR-021：關鍵流程需有可理解錯誤訊息與復原路徑。

### 13.4 可維運性

- NFR-030：三端模組化維護（client/org/platform 分層）。
- NFR-031：版本可回溯，與 versions.json 對齊。

---

## 14. 錯誤碼與例外處理（建議）

| 錯誤碼 | 說明 | 處理方式 |
|---|---|---|
| E4001 | 邀請碼無效 | 顯示重新輸入並提供聯絡機構入口 |
| E4002 | OTP 驗證失敗 | 顯示剩餘次數，超限後鎖定 |
| E4101 | 無權限操作 | 顯示無權限訊息並導回可用頁 |
| E4201 | 訂單狀態衝突 | 重新同步訂單狀態後重試 |
| E5001 | 外部金流逾時 | 訂單保持待付款並可重試支付 |
| E5002 | 推播發送失敗 | 寫入重送佇列並告警 |

---

## 15. 需求追蹤矩陣（RTM）

| 需求 | Use Case | 頁面 | 資料實體 | API | 驗收測項 |
|---|---|---|---|---|---|
| FR-C-001 | UC-C-01 | 1.客戶端/caregiver-binding.html | user、member_binding | /bindings/request-otp、/bindings/verify | AT-C-01 |
| FR-C-004 | UC-C-02 | 1.客戶端/checkout.html、orders.html | order、order_item | /orders、/orders/{id}/pay-callback | AT-C-02 |
| FR-O-001 | UC-O-01 | 2.機構端/member-review.html | member_binding、audit_log | /member-bindings/{id}/review | AT-O-01 |
| FR-O-003 | UC-O-02 | 2.機構端/orders.html | order、organization | /orders | AT-O-02 |
| FR-P-001 | UC-P-01 | 3.平台端/org-review.html | organization、audit_log | /admin/organizations/review | AT-P-01 |
| FR-P-006 | UC-P-02 | 3.平台端/tickets.html | ticket、ticket_reply | /tickets/{id}/assign、/tickets/{id}/status | AT-P-02 |
| FR-P-007 | UC-P-03 | 3.平台端/roles.html | role、permission | /admin/roles | AT-P-03 |

---

## 16. 驗收條件（AT）

- AT-C-01：輸入有效邀請碼 + 正確 OTP，綁定成功且可見於綁定列表。
- AT-C-02：建立訂單後付款成功，訂單狀態可由 pending_payment 轉為 paid。
- AT-O-01：機構端可完成綁定申請之核准/駁回，並寫入審核紀錄。
- AT-O-02：機構端可依日期與狀態篩選訂單，並檢視分潤明細。
- AT-P-01：平台端可完成機構審核並可啟用/停用。
- AT-P-02：客服單可完成指派、處理、結案全流程，逾時可告警。
- AT-P-03：角色權限調整後，即時影響可見功能選單與 API 存取。

---

## 17. 假設與待確認事項

1. 金流與簡訊供應商尚未定版，API 欄位與簽章規則待補。
2. 退款責任歸屬（機構/平台）需再確認審核責任切分。
3. 客服 SLA（不同優先級）需由營運單位定義具體門檻。
4. 報表匯出欄位與財務口徑需由財務單位確認。

---

## 18. 後續輸出建議（銜接 SD）

1. 產出 API 詳細介面契約（Request/Response Schema）。
2. 產出資料庫實體設計（DDL、索引、唯一鍵、外鍵）。
3. 產出序列圖（綁定、下單付款、客服分派）。
4. 產出權限碼表與選單權限對照。

---

## 19. 附錄：頁面盤點（依現況）

### 19.1 客戶端

- index.html
- categories.html
- search.html
- service-detail.html
- checkout.html
- orders.html / order-detail.html
- messages.html / message-detail.html
- announcements.html / announcement-detail.html
- chat.html / chat-detail.html
- profile.html / edit-profile.html
- caregiver-binding.html
- contact.html / faq.html
- promotions.html
- ticket-detail.html

### 19.2 機構端

- index.html
- members.html
- member-binding.html
- member-review.html
- orders.html
- announcements.html
- chat.html
- admins.html
- organization.html

### 19.3 平台端

- index.html
- organizations.html
- org-review.html
- members.html
- orders.html
- categories.html
- services.html
- announcements.html
- tickets.html
- admins.html
- roles.html
- logs.html

---

## 20. 系統設計文件（SD）整併內容

> 以下內容原為 `需求資料/系統設計文件.md`，已整併至本文件。

## 1. 文件控管

| 項目 | 內容 |
|---|---|
| 文件名稱 | 全方位智慧貼身照護平台－系統設計文件 |
| 文件代碼 | SD-SMART-HEALTHCARE-001 |
| 文件版本 | v1.0 |
| 文件日期 | 2026-02-26 |
| 上游文件 | 需求資料/系統規格文件.md（SA v2.0） |
| 文件目的 | 將 SA 需求轉為可實作的系統架構、API 契約與資料庫設計 |

### 1.1 與 SA 追溯關係

| SA 區塊 | SD 對應章節 |
|---|---|
| FR-C-001 ~ FR-C-007 | 5 模組設計、6 API 設計、7 DB 設計 |
| FR-O-001 ~ FR-O-006 | 5 模組設計、6 API 設計、7 DB 設計 |
| FR-P-001 ~ FR-P-008 | 5 模組設計、6 API 設計、7 DB 設計、8 安全與稽核 |
| UC-C/O/P | 9 序列流程設計 |
| NFR-001 ~ NFR-031 | 10 非功能設計 |

---

## 2. 設計目標與原則

### 2.1 設計目標

1. 支援三端（客戶端/機構端/平台端）一致的服務層與資料層。
2. 提供可擴充的 RBAC 權限控管與稽核能力。
3. 提供交易型流程（綁定、下單、客服）的一致性與可追蹤性。
4. API 契約穩定、可版本化、可測試。

### 2.2 設計原則

- 分層架構：前端、API、Domain Service、Infrastructure、DB 分離。
- 模組內聚：依業務域拆分模組，避免單體巨型服務邏輯。
- 追溯一致：所有核心功能可回溯到 FR 與 UC。
- 安全預設：管理端與敏感操作預設最小權限。
- 可觀測性：每個關鍵流程有日誌、指標、追蹤 ID。

---

## 3. 系統總體架構

### 3.1 邏輯架構

1. Presentation Layer
   - 客戶端前端（1.客戶端）
   - 機構端前端（2.機構端）
   - 平台端前端（3.平台端）
2. API Layer
   - REST API（/api/v1）
   - JWT 驗證與 RBAC 中介層
3. Domain Services
   - Identity Service
   - Binding Service
   - Catalog Service
   - Order Service
   - Ticket Service
   - Announcement Service
   - Messaging Service
   - Governance Service（機構/會員/權限/日誌）
4. Integration Layer
   - OTP Adapter
   - Payment Adapter
   - Notification Adapter
5. Data Layer
   - MySQL 8（交易資料）
   - 可選：Redis（OTP、暫存、限流）

### 3.2 實體部署建議（環境分層）

- DEV：開發環境（可共享 DB instance，不共享 schema）。
- SIT：整合測試環境（外部服務使用 sandbox）。
- UAT：驗收環境（資料脫敏）。
- PROD：正式環境（高可用、備援、監控、告警）。

---

## 4. 模組設計

### 4.1 Identity & Access 模組

- 責任：登入、Token 簽發、角色授權、權限檢核。
- 主要實體：users、roles、permissions、user_roles、role_permissions。
- 關聯 FR：FR-P-007、FR-P-008。

### 4.2 Binding 模組

- 責任：邀請碼綁定、OTP 發送與驗證、機構審核。
- 主要實體：member_bindings、otp_records。
- 關聯 FR：FR-C-001、FR-O-001。

### 4.3 Catalog 模組

- 責任：類別管理、服務管理、上架下架與查詢。
- 主要實體：service_categories、services。
- 關聯 FR：FR-C-003、FR-P-004。

### 4.4 Order 模組

- 責任：建立訂單、付款回寫、訂單狀態轉移、退款審核。
- 主要實體：orders、order_items、payment_events、order_status_logs。
- 關聯 FR：FR-C-004、FR-O-003、FR-P-003。

### 4.5 Ticket 模組

- 責任：客服提單、分派、狀態流轉、回覆與 SLA。
- 主要實體：tickets、ticket_replies。
- 關聯 FR：FR-C-007、FR-P-006。

### 4.6 Announcement 模組

- 責任：平台/機構公告管理、投放對象設定、發布排程。
- 主要實體：announcements。
- 關聯 FR：FR-O-004、FR-P-005。

### 4.7 Messaging 模組

- 責任：聊天室、訊息傳遞、已讀回條。
- 主要實體：chat_rooms、messages。
- 關聯 FR：FR-C-006、FR-O-005。

### 4.8 Governance 模組

- 責任：機構治理、會員治理、操作日誌、異常檢核。
- 主要實體：organizations、audit_logs。
- 關聯 FR：FR-P-001、FR-P-002、FR-P-008。

---

## 5. API 設計規格

## 5.1 通用規範

- Base URL：/api/v1
- 認證方式：Bearer JWT
- 內容格式：application/json
- 時區：UTC+8（寫入 DB 使用 UTC，回傳可轉換）
- 分頁欄位：page、pageSize、total、items
- 追蹤欄位：x-request-id（Header）

### 5.2 回應包裝格式

| 欄位 | 型別 | 說明 |
|---|---|---|
| success | boolean | 是否成功 |
| code | string | 業務碼（如 OK、E4001） |
| message | string | 顯示訊息 |
| data | object | 回傳資料 |
| traceId | string | 追蹤識別 |

### 5.3 核心 API 詳規

#### A. 綁定流程

##### POST /api/v1/bindings/request-otp

- 權限：ACT-C
- 用途：送出邀請碼後，要求系統發送 OTP

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| inviteCode | string | Y | 邀請碼 |
| phone | string | Y | 驗證手機 |

Response data 欄位

| 欄位 | 型別 | 說明 |
|---|---|---|
| requestId | string | OTP 請求識別碼 |
| expiresInSec | number | OTP 有效秒數 |
| retryAfterSec | number | 下次可重送秒數 |

##### POST /api/v1/bindings/verify

- 權限：ACT-C
- 用途：驗證 OTP 並建立綁定

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| requestId | string | Y | OTP 請求識別碼 |
| otpCode | string | Y | 驗證碼 |

Response data 欄位

| 欄位 | 型別 | 說明 |
|---|---|---|
| bindingId | number | 綁定主鍵 |
| status | string | active/pending |

#### B. 服務查詢

##### GET /api/v1/services

- 權限：Public/ACT-C
- 用途：服務列表查詢

Query 參數

| 參數 | 型別 | 必填 | 說明 |
|---|---|---|---|
| keyword | string | N | 關鍵字 |
| categoryId | number | N | 類別 |
| minPrice | number | N | 最低價格 |
| maxPrice | number | N | 最高價格 |
| sortBy | string | N | price/newest/popular |
| page | number | N | 頁碼 |
| pageSize | number | N | 每頁筆數 |

#### C. 訂單交易

##### POST /api/v1/orders

- 權限：ACT-C
- 用途：建立訂單

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| memberId | number | Y | 下單會員 |
| orgId | number | Y | 所屬機構 |
| idempotencyKey | string | Y | 防重複提交鍵值 |
| items | array | Y | 訂單品項 |
| paymentMethod | string | Y | card/linepay/bank |
| couponCode | string | N | 優惠碼 |

items 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| serviceId | number | Y | 服務 ID |
| qty | number | Y | 數量 |
| spec | string | N | 規格描述 |

Response data 欄位

| 欄位 | 型別 | 說明 |
|---|---|---|
| orderId | number | 訂單主鍵 |
| orderNo | string | 訂單編號 |
| orderStatus | string | pending_payment |
| paymentUrl | string | 金流導轉網址 |

##### POST /api/v1/orders/{id}/pay-callback

- 權限：ACT-SYS（簽章驗證）
- 用途：接收金流回寫

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| providerTxnId | string | Y | 第三方交易編號 |
| paidAmount | number | Y | 付款金額 |
| paidAt | datetime | Y | 付款時間 |
| result | string | Y | success/fail |
| signature | string | Y | 回調簽章 |

##### GET /api/v1/orders

- 權限：ACT-C / ACT-O / ACT-P（依資料範圍）
- 用途：查詢訂單列表

Query 參數

| 參數 | 型別 | 必填 | 說明 |
|---|---|---|---|
| status | string | N | 訂單狀態 |
| paymentStatus | string | N | 付款狀態 |
| memberId | number | N | 會員（機構/平台可用） |
| orgId | number | N | 機構（平台可用） |
| dateFrom | date | N | 起始日期 |
| dateTo | date | N | 結束日期 |

#### D. 機構綁定審核

##### PATCH /api/v1/member-bindings/{id}/review

- 權限：ACT-O
- 用途：審核綁定申請

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| action | string | Y | approve/reject |
| comment | string | N | 審核備註 |

#### E. 客服流程

##### POST /api/v1/tickets

- 權限：ACT-C / ACT-O
- 用途：建立客服單

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| sourceType | string | Y | client/org |
| type | string | Y | 問題類型 |
| subject | string | Y | 標題 |
| content | string | Y | 內容 |
| priority | string | Y | low/medium/high/urgent |

##### PATCH /api/v1/tickets/{id}/assign

- 權限：ACT-P
- 用途：指派處理人員

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| assigneeId | number | Y | 指派人員 ID |
| dueAt | datetime | N | 目標完成時間 |

##### PATCH /api/v1/tickets/{id}/status

- 權限：ACT-P
- 用途：更新工單狀態

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| status | string | Y | in_progress/resolved/closed |
| note | string | N | 處理備註 |

#### F. 權限與稽核

##### GET /api/v1/admin/roles
##### POST /api/v1/admin/roles
##### PATCH /api/v1/admin/roles/{id}
##### DELETE /api/v1/admin/roles/{id}

- 權限：ACT-P
- 用途：角色與權限維護

##### GET /api/v1/admin/logs

- 權限：ACT-P
- 用途：操作日誌查詢

Query 參數

| 參數 | 型別 | 必填 | 說明 |
|---|---|---|---|
| operatorId | number | N | 操作者 |
| module | string | N | 模組 |
| action | string | N | 操作類型 |
| dateFrom | date | N | 起日 |
| dateTo | date | N | 迄日 |

---

## 6. 資料庫實體設計（MySQL 8.0）

### 6.1 設計原則

- 主鍵：BIGINT UNSIGNED AUTO_INCREMENT
- 時間欄位：created_at、updated_at（UTC）
- 交易欄位：金額使用 DECIMAL(12,2)
- 多值資料：優先正規化，必要時使用 JSON
- 稽核需求：關鍵表維護 status log 或 audit log

### 6.2 DDL 草案

```sql
CREATE DATABASE IF NOT EXISTS smart_healthcare
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_0900_ai_ci;

USE smart_healthcare;

CREATE TABLE users (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  role_type VARCHAR(20) NOT NULL,
  name VARCHAR(100) NOT NULL,
  phone VARCHAR(20) NOT NULL,
  email VARCHAR(255) NULL,
  password_hash VARCHAR(255) NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_users_phone (phone),
  KEY idx_users_role_status (role_type, status)
);

CREATE TABLE organizations (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  tax_id VARCHAR(20) NOT NULL,
  owner_name VARCHAR(100) NOT NULL,
  contact_phone VARCHAR(20) NOT NULL,
  email VARCHAR(255) NULL,
  address VARCHAR(255) NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  revenue_ratio DECIMAL(5,2) NOT NULL DEFAULT 0.00,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_organizations_tax_id (tax_id),
  KEY idx_organizations_status (status)
);

CREATE TABLE roles (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  scope_type VARCHAR(20) NOT NULL,
  name VARCHAR(100) NOT NULL,
  description VARCHAR(255) NULL,
  role_level INT NOT NULL DEFAULT 1,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_roles_scope_name (scope_type, name)
);

CREATE TABLE permissions (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  module_code VARCHAR(50) NOT NULL,
  action_code VARCHAR(20) NOT NULL,
  description VARCHAR(255) NULL,
  UNIQUE KEY uk_permissions_module_action (module_code, action_code)
);

CREATE TABLE role_permissions (
  role_id BIGINT UNSIGNED NOT NULL,
  permission_id BIGINT UNSIGNED NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (role_id, permission_id),
  CONSTRAINT fk_rp_role FOREIGN KEY (role_id) REFERENCES roles(id),
  CONSTRAINT fk_rp_permission FOREIGN KEY (permission_id) REFERENCES permissions(id)
);

CREATE TABLE user_roles (
  user_id BIGINT UNSIGNED NOT NULL,
  role_id BIGINT UNSIGNED NOT NULL,
  org_id BIGINT UNSIGNED NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (user_id, role_id, org_id),
  CONSTRAINT fk_ur_user FOREIGN KEY (user_id) REFERENCES users(id),
  CONSTRAINT fk_ur_role FOREIGN KEY (role_id) REFERENCES roles(id),
  CONSTRAINT fk_ur_org FOREIGN KEY (org_id) REFERENCES organizations(id)
);

CREATE TABLE member_bindings (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  member_id BIGINT UNSIGNED NOT NULL,
  org_id BIGINT UNSIGNED NOT NULL,
  invite_code VARCHAR(50) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  reviewer_id BIGINT UNSIGNED NULL,
  reviewed_at DATETIME NULL,
  expire_at DATETIME NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY idx_member_bindings_member (member_id),
  KEY idx_member_bindings_org_status (org_id, status),
  KEY idx_member_bindings_invite_code (invite_code),
  CONSTRAINT fk_mb_member FOREIGN KEY (member_id) REFERENCES users(id),
  CONSTRAINT fk_mb_org FOREIGN KEY (org_id) REFERENCES organizations(id),
  CONSTRAINT fk_mb_reviewer FOREIGN KEY (reviewer_id) REFERENCES users(id)
);

CREATE TABLE otp_records (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  request_id VARCHAR(64) NOT NULL,
  phone VARCHAR(20) NOT NULL,
  otp_hash VARCHAR(255) NOT NULL,
  purpose VARCHAR(30) NOT NULL,
  expired_at DATETIME NOT NULL,
  verified_at DATETIME NULL,
  failed_count INT NOT NULL DEFAULT 0,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_otp_request_id (request_id),
  KEY idx_otp_phone_purpose (phone, purpose)
);

CREATE TABLE service_categories (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  parent_id BIGINT UNSIGNED NULL,
  name VARCHAR(100) NOT NULL,
  description VARCHAR(255) NULL,
  sort_order INT NOT NULL DEFAULT 0,
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY idx_service_categories_parent (parent_id),
  KEY idx_service_categories_status_sort (status, sort_order),
  CONSTRAINT fk_sc_parent FOREIGN KEY (parent_id) REFERENCES service_categories(id)
);

CREATE TABLE services (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  category_id BIGINT UNSIGNED NOT NULL,
  org_id BIGINT UNSIGNED NULL,
  name VARCHAR(200) NOT NULL,
  description TEXT NULL,
  base_price DECIMAL(12,2) NOT NULL,
  sale_price DECIMAL(12,2) NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'on_shelf',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY idx_services_category_status (category_id, status),
  KEY idx_services_org (org_id),
  CONSTRAINT fk_services_category FOREIGN KEY (category_id) REFERENCES service_categories(id),
  CONSTRAINT fk_services_org FOREIGN KEY (org_id) REFERENCES organizations(id)
);

CREATE TABLE orders (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  order_no VARCHAR(40) NOT NULL,
  member_id BIGINT UNSIGNED NOT NULL,
  org_id BIGINT UNSIGNED NOT NULL,
  order_status VARCHAR(30) NOT NULL DEFAULT 'pending_payment',
  payment_status VARCHAR(30) NOT NULL DEFAULT 'unpaid',
  payment_method VARCHAR(30) NOT NULL,
  currency CHAR(3) NOT NULL DEFAULT 'TWD',
  subtotal_amount DECIMAL(12,2) NOT NULL,
  discount_amount DECIMAL(12,2) NOT NULL DEFAULT 0.00,
  shipping_fee DECIMAL(12,2) NOT NULL DEFAULT 0.00,
  total_amount DECIMAL(12,2) NOT NULL,
  idempotency_key VARCHAR(80) NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_orders_order_no (order_no),
  UNIQUE KEY uk_orders_idempotency_key (idempotency_key),
  KEY idx_orders_member_created (member_id, created_at),
  KEY idx_orders_org_created (org_id, created_at),
  KEY idx_orders_status (order_status, payment_status),
  CONSTRAINT fk_orders_member FOREIGN KEY (member_id) REFERENCES users(id),
  CONSTRAINT fk_orders_org FOREIGN KEY (org_id) REFERENCES organizations(id)
);

CREATE TABLE order_items (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  order_id BIGINT UNSIGNED NOT NULL,
  service_id BIGINT UNSIGNED NOT NULL,
  service_name_snapshot VARCHAR(200) NOT NULL,
  spec_snapshot VARCHAR(255) NULL,
  qty INT NOT NULL,
  unit_price DECIMAL(12,2) NOT NULL,
  line_total DECIMAL(12,2) NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  KEY idx_order_items_order (order_id),
  CONSTRAINT fk_order_items_order FOREIGN KEY (order_id) REFERENCES orders(id),
  CONSTRAINT fk_order_items_service FOREIGN KEY (service_id) REFERENCES services(id)
);

CREATE TABLE payment_events (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  order_id BIGINT UNSIGNED NOT NULL,
  provider_name VARCHAR(50) NOT NULL,
  provider_txn_id VARCHAR(100) NOT NULL,
  event_type VARCHAR(30) NOT NULL,
  event_result VARCHAR(20) NOT NULL,
  raw_payload JSON NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_payment_events_provider_txn (provider_name, provider_txn_id, event_type),
  KEY idx_payment_events_order (order_id),
  CONSTRAINT fk_payment_events_order FOREIGN KEY (order_id) REFERENCES orders(id)
);

CREATE TABLE order_status_logs (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  order_id BIGINT UNSIGNED NOT NULL,
  from_status VARCHAR(30) NULL,
  to_status VARCHAR(30) NOT NULL,
  operator_id BIGINT UNSIGNED NULL,
  reason VARCHAR(255) NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  KEY idx_order_status_logs_order (order_id, created_at),
  CONSTRAINT fk_osl_order FOREIGN KEY (order_id) REFERENCES orders(id),
  CONSTRAINT fk_osl_operator FOREIGN KEY (operator_id) REFERENCES users(id)
);

CREATE TABLE announcements (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  source_type VARCHAR(20) NOT NULL,
  org_id BIGINT UNSIGNED NULL,
  title VARCHAR(200) NOT NULL,
  content MEDIUMTEXT NOT NULL,
  level VARCHAR(20) NOT NULL DEFAULT 'normal',
  target_type VARCHAR(30) NOT NULL,
  publish_at DATETIME NULL,
  expire_at DATETIME NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'draft',
  created_by BIGINT UNSIGNED NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY idx_announcements_source_status (source_type, status),
  KEY idx_announcements_publish (publish_at, expire_at),
  CONSTRAINT fk_announcements_org FOREIGN KEY (org_id) REFERENCES organizations(id),
  CONSTRAINT fk_announcements_creator FOREIGN KEY (created_by) REFERENCES users(id)
);

CREATE TABLE tickets (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ticket_no VARCHAR(40) NOT NULL,
  source_type VARCHAR(20) NOT NULL,
  creator_id BIGINT UNSIGNED NOT NULL,
  org_id BIGINT UNSIGNED NULL,
  type VARCHAR(50) NOT NULL,
  subject VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  priority VARCHAR(20) NOT NULL DEFAULT 'medium',
  status VARCHAR(20) NOT NULL DEFAULT 'open',
  assignee_id BIGINT UNSIGNED NULL,
  due_at DATETIME NULL,
  closed_at DATETIME NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_tickets_ticket_no (ticket_no),
  KEY idx_tickets_status_priority (status, priority),
  KEY idx_tickets_assignee (assignee_id),
  KEY idx_tickets_creator (creator_id),
  CONSTRAINT fk_tickets_creator FOREIGN KEY (creator_id) REFERENCES users(id),
  CONSTRAINT fk_tickets_assignee FOREIGN KEY (assignee_id) REFERENCES users(id),
  CONSTRAINT fk_tickets_org FOREIGN KEY (org_id) REFERENCES organizations(id)
);

CREATE TABLE ticket_replies (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ticket_id BIGINT UNSIGNED NOT NULL,
  replier_id BIGINT UNSIGNED NOT NULL,
  is_internal TINYINT(1) NOT NULL DEFAULT 0,
  content TEXT NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  KEY idx_ticket_replies_ticket_created (ticket_id, created_at),
  CONSTRAINT fk_ticket_replies_ticket FOREIGN KEY (ticket_id) REFERENCES tickets(id),
  CONSTRAINT fk_ticket_replies_replier FOREIGN KEY (replier_id) REFERENCES users(id)
);

CREATE TABLE chat_rooms (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  room_type VARCHAR(20) NOT NULL,
  member_id BIGINT UNSIGNED NULL,
  org_id BIGINT UNSIGNED NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  KEY idx_chat_rooms_member_org (member_id, org_id),
  CONSTRAINT fk_chat_rooms_member FOREIGN KEY (member_id) REFERENCES users(id),
  CONSTRAINT fk_chat_rooms_org FOREIGN KEY (org_id) REFERENCES organizations(id)
);

CREATE TABLE messages (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  room_id BIGINT UNSIGNED NOT NULL,
  sender_id BIGINT UNSIGNED NOT NULL,
  message_type VARCHAR(20) NOT NULL DEFAULT 'text',
  content TEXT NULL,
  attachment_url VARCHAR(500) NULL,
  read_at DATETIME NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  KEY idx_messages_room_created (room_id, created_at),
  KEY idx_messages_sender (sender_id),
  CONSTRAINT fk_messages_room FOREIGN KEY (room_id) REFERENCES chat_rooms(id),
  CONSTRAINT fk_messages_sender FOREIGN KEY (sender_id) REFERENCES users(id)
);

CREATE TABLE audit_logs (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  operator_id BIGINT UNSIGNED NOT NULL,
  module_code VARCHAR(50) NOT NULL,
  action_code VARCHAR(20) NOT NULL,
  target_type VARCHAR(50) NULL,
  target_id VARCHAR(100) NULL,
  before_json JSON NULL,
  after_json JSON NULL,
  request_id VARCHAR(64) NULL,
  ip VARCHAR(50) NOT NULL,
  user_agent VARCHAR(500) NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  KEY idx_audit_logs_operator_created (operator_id, created_at),
  KEY idx_audit_logs_module_action_created (module_code, action_code, created_at),
  CONSTRAINT fk_audit_logs_operator FOREIGN KEY (operator_id) REFERENCES users(id)
);
```

---

## 7. 權限模型與授權流程

### 7.1 RBAC 模型

1. 使用者可持有多角色（user_roles）。
2. 角色可包含多權限（role_permissions）。
3. 權限粒度：module_code + action_code。
4. 管理端 API 一律經過 RBAC 中介層檢核。

### 7.2 權限碼建議

| module_code | action_code |
|---|---|
| ORG_REVIEW | READ/APPROVE/REJECT |
| ORDER | READ/UPDATE/REFUND |
| TICKET | READ/ASSIGN/UPDATE/CLOSE |
| ROLE | READ/CREATE/UPDATE/DELETE |
| AUDIT_LOG | READ |

---

## 8. 安全、稽核與合規設計

### 8.1 安全控制

- API 驗證：JWT + Token 過期 + Refresh Token。
- 敏感資料：手機、Email 顯示遮罩；密碼雜湊儲存。
- 外部回調：簽章驗證 + IP 白名單 + 重放防護。
- 交易防重：idempotency_key、provider_txn_id 唯一索引。

### 8.2 稽核控制

- 管理端 C/U/D 必寫 audit_logs。
- 訂單與客服單狀態變更需有 status log。
- 每個 API 請求具 request_id 可追溯。

---

## 9. 關鍵流程序列設計

### 9.1 綁定流程（UC-C-01）

1. 前端送 inviteCode/phone 至 request-otp。
2. Binding Service 檢核邀請碼，建立 otp_records。
3. OTP Adapter 發送簡訊。
4. 使用者輸入 otpCode 呼叫 verify。
5. 驗證成功後寫 member_bindings 並回傳綁定結果。

### 9.2 下單付款流程（UC-C-02）

1. 前端送出建立訂單（含 idempotency_key）。
2. Order Service 交易建立 orders/order_items。
3. 回傳 paymentUrl 導向金流。
4. 金流呼叫 pay-callback。
5. 系統更新 orders 狀態、寫 payment_events 與 order_status_logs。
6. 發送通知給客戶端與機構端。

### 9.3 客服單流程（UC-P-02）

1. 建單：建立 tickets。
2. 指派：更新 assignee_id、status=in_progress。
3. 回覆：寫 ticket_replies（可區分內外部備註）。
4. 完成：status=resolved/closed，寫 audit_logs。

---

## 10. 非功能設計（對應 NFR）

### 10.1 效能

- 訂單、查詢 API 需有適當索引與分頁上限。
- 公告、服務列表可加入快取（TTL 60~180 秒）。
- API 逾時建議：讀取 3 秒、交易 8 秒、外部回調 10 秒。

### 10.2 可用性

- 所有關鍵交易提供可重試設計。
- 外部服務異常時採降級策略（先記錄，後補償）。

### 10.3 可維運性

- 日誌分級：ERROR/WARN/INFO。
- 監控指標：API 成功率、P95、付款成功率、工單 SLA 達成率。

---

## 11. 設計追蹤矩陣（SD-RTM）

| FR | 模組 | 主要 API | 主要資料表 |
|---|---|---|---|
| FR-C-001 | Binding | /bindings/request-otp、/bindings/verify | member_bindings、otp_records |
| FR-C-004 | Order | /orders、/orders/{id}/pay-callback | orders、order_items、payment_events |
| FR-O-001 | Binding | /member-bindings/{id}/review | member_bindings、audit_logs |
| FR-O-003 | Order | /orders | orders、order_items |
| FR-P-001 | Governance | /admin/organizations/review（SD 實作） | organizations、audit_logs |
| FR-P-006 | Ticket | /tickets、/tickets/{id}/assign、/tickets/{id}/status | tickets、ticket_replies |
| FR-P-007 | Identity & Access | /admin/roles | roles、permissions、role_permissions |
| FR-P-008 | Governance | /admin/logs | audit_logs |

---

## 12. 版本與遷移策略

### 12.1 API 版本策略

- 採 URI 版號：/api/v1
- 破壞性調整升級為 /api/v2
- 舊版 API 至少保留一個完整版本週期

### 12.2 DB Migration 策略

- 採遷移腳本管理（向上/向下腳本）。
- 每次發版前執行 schema drift 檢查。
- 生產環境 DDL 需經審核窗口與備援演練。

---

## 13. 後續交付清單

1. OpenAPI 3.1 文件（依本文件 API 欄位展開）。
2. 實際 migration SQL 檔案與 seed 腳本。
3. 權限碼表（Permission Catalog）與角色預設模板。
4. 端到端測試案例（綁定、下單付款、客服分派）。

---

## 14. 待確認事項

1. 外部金流實際欄位與簽章規格。
2. OTP 供應商與發送限制策略。
3. 客服 SLA 門檻（依優先級）最終值。
4. 訂單取消與退款的責任邊界（機構端/平台端）。
