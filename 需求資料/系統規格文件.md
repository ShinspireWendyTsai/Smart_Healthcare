# 全方位智慧貼身照護平台－系統分析規格書（SA）

## 1. 文件控管

| 項目 | 內容 |
|---|---|
| 文件名稱 | 全方位智慧貼身照護平台－系統分析規格書 |
| 文件代碼 | SA-SMART-HEALTHCARE-001 |
| 文件版本 | v2.0 |
| 文件日期 | 2026-02-26 |
| 適用範圍 | 客戶端、機構端、平台端 |
| 主要依據 | 需求資料/系統藍圖.md、現有前端原型頁面 |

### 1.1 修訂紀錄

| 版本 | 日期 | 修訂內容 |
|---|---|---|
| v1.0 | 2026-02-26 | 初版功能規格 |
| v2.0 | 2026-02-26 | 轉為系統分析格式（Use Case、資料字典、狀態機、追蹤矩陣） |

---

## 2. 分析目的與方法

### 2.1 分析目的

本文件目的為建立可直接銜接系統設計（SD）與開發實作的分析規格，明確定義：

1. 業務流程與系統邊界。
2. 角色、權限與功能責任。
3. 主要 Use Case 與例外流程。
4. 邏輯資料模型與資料字典。
5. 模組、頁面、API、資料實體之追蹤關係。

### 2.2 分析方法

- 文件分析：依系統藍圖盤點需求。
- 原型比對：依三端現有頁面映射功能模組。
- 需求結構化：以 FR / UC / BR / NFR 編碼。
- 可追溯分析：建立需求追蹤矩陣（RTM）。

---

## 3. 系統邊界與上下游

### 3.1 系統邊界（System Boundary）

本系統提供三端入口：

- 客戶端：個案、家屬之服務使用與互動。
- 機構端：合作機構日常營運與個案服務管理。
- 平台端：全平台治理、審核、權限與稽核。

### 3.2 外部系統（External Systems）

| 外部系統 | 目的 | 串接方向 |
|---|---|---|
| 簡訊服務（OTP） | 手機驗證碼發送 | 本系統 → 簡訊供應商 |
| 金流服務 | 訂單付款、退款 | 本系統 ↔ 金流平台 |
| 通知服務 | 推播訊息通知 | 本系統 → 推播通道 |
| 郵件服務 | 系統通知/客服回覆 | 本系統 → 郵件服務 |

### 3.3 本期範圍與排除範圍

**本期範圍（In Scope）**

- 三端主要功能流程與資料處理。
- 訂單、客服單、公告、角色權限與操作紀錄。

**排除範圍（Out of Scope）**

- AI 推薦/預測模型。
- 醫療設備即時資料串流。
- 完整多語系翻譯治理流程。

---

## 4. 現況（As-Is）與目標（To-Be）分析

> 註：As-Is 以現有藍圖與原型狀態推定，用於分析差距；最終以需求會議確認為準。

| 面向 | As-Is（目前） | To-Be（目標） |
|---|---|---|
| 入口與角色 | 三端入口已分離，功能描述明確 | 建立統一帳號授權模型與角色授權控管 |
| 訂單流程 | 已有前端流程頁面 | 補齊狀態機、金流回寫、異常補償 |
| 綁定流程 | 有綁定/審核頁面與需求敘述 | 建立完整 OTP、審核、失效與重送規則 |
| 客服流程 | 已有客服單與詳情頁 | 建立 SLA、指派、升級與追蹤機制 |
| 稽核治理 | 平台端有 logs 頁面 | 落實敏感操作全量記錄與查核 |

---

## 5. 角色與權責分析

| 角色代碼 | 角色名稱 | 說明 | 核心責任 |
|---|---|---|---|
| ACT-C | 客戶端使用者（個案/家屬） | 服務使用者 | 綁定、下單、查單、通訊、提單 |
| ACT-O | 機構管理者 | 合作機構人員 | 個案審核、公告、通訊、分潤查詢 |
| ACT-P | 平台管理者 | 系統最高管理權限 | 機構審核、主資料治理、客服稽核、權限與日誌 |
| ACT-SYS | 外部服務 | 系統整合角色 | OTP、金流、推播回調 |

---

## 6. 需求分解（FR）

### 6.1 客戶端需求

- FR-C-001：邀請碼綁定與 OTP 驗證。
- FR-C-002：家人/關懷者綁定與解除。
- FR-C-003：服務瀏覽、搜尋、篩選、排序。
- FR-C-004：購物車、結帳、付款、訂單追蹤。
- FR-C-005：通知中心（未讀、已讀、刪除、跳轉）。
- FR-C-006：即時通訊與訊息查詢。
- FR-C-007：客服提單、查詢、回覆通知。

### 6.2 機構端需求

- FR-O-001：個案綁定邀請碼管理與審核。
- FR-O-002：個案主檔與服務歷程查詢。
- FR-O-003：訂單與分潤報表查詢。
- FR-O-004：機構公告管理與閱讀統計。
- FR-O-005：機構通訊管理（單聊/群發）。
- FR-O-006：機構管理者與角色管理。

### 6.3 平台端需求

- FR-P-001：機構審核與啟停管理。
- FR-P-002：會員管理與帳號狀態治理。
- FR-P-003：全平台訂單查詢、異常處理、退款審核。
- FR-P-004：服務類別與服務主檔管理。
- FR-P-005：平台公告與投放對象管理。
- FR-P-006：客服單分派、時效追蹤、統計。
- FR-P-007：平台管理者、角色、權限治理。
- FR-P-008：操作日誌查詢與異常行為監控。

---

## 7. Use Case 分析

### 7.1 Use Case 清單

| UC 編號 | 名稱 | 主要角色 | 關聯需求 |
|---|---|---|---|
| UC-C-01 | 個案帳號綁定 | ACT-C | FR-C-001 |
| UC-C-02 | 建立訂單與付款 | ACT-C | FR-C-004 |
| UC-C-03 | 提交客服單 | ACT-C | FR-C-007 |
| UC-O-01 | 審核個案綁定申請 | ACT-O | FR-O-001 |
| UC-O-02 | 查詢訂單與分潤 | ACT-O | FR-O-003 |
| UC-P-01 | 機構審核與啟用 | ACT-P | FR-P-001 |
| UC-P-02 | 客服單分派與結案 | ACT-P | FR-P-006 |
| UC-P-03 | 角色權限設定 | ACT-P | FR-P-007 |

### 7.2 Use Case 詳細規格

#### UC-C-01 個案帳號綁定

- 目標：建立客戶端使用者與個案的合法綁定關係。
- 前置條件：使用者已登入；邀請碼存在且有效。
- 觸發條件：使用者送出邀請碼。
- 主要流程：
  1. 系統驗證邀請碼有效性。
  2. 系統發送 OTP 至綁定手機。
  3. 使用者輸入 OTP。
  4. 系統驗證成功，建立綁定記錄。
  5. 系統通知機構端與個案關係人。
- 例外流程：
  - E1：邀請碼無效/過期，回傳錯誤並要求重新輸入。
  - E2：OTP 錯誤超過上限，暫時鎖定並要求重送。
- 後置條件：綁定狀態為 `active`，寫入稽核日誌。
- 關聯頁面：1.客戶端/caregiver-binding.html

#### UC-C-02 建立訂單與付款

- 目標：完成服務訂購與付款。
- 前置條件：商品已上架；購物車非空。
- 觸發條件：使用者於結帳頁按下送出訂單。
- 主要流程：
  1. 系統檢核商品可售、價格、折扣。
  2. 建立訂單（狀態：`pending_payment`）。
  3. 導向金流交易並取得結果。
  4. 付款成功後更新為 `paid`。
  5. 產生通知並同步機構端查詢。
- 例外流程：
  - E1：付款失敗，訂單保留於 `pending_payment`。
  - E2：逾時未付款，系統排程轉為 `cancelled`。
- 後置條件：可由客戶端與機構端追蹤訂單狀態。
- 關聯頁面：1.客戶端/checkout.html、1.客戶端/orders.html

#### UC-O-01 審核個案綁定申請

- 目標：機構端審核個案綁定請求。
- 前置條件：存在待審核綁定申請。
- 觸發條件：機構管理者於審核頁執行核准或駁回。
- 主要流程：
  1. 顯示待審核申請明細。
  2. 管理者核准或駁回。
  3. 系統更新狀態並記錄審核者與時間。
  4. 系統通知申請者審核結果。
- 例外流程：
  - E1：資料不足無法審核，要求補件。
- 後置條件：申請狀態由 `pending` 轉為 `approved` / `rejected`。
- 關聯頁面：2.機構端/member-review.html

#### UC-P-02 客服單分派與結案

- 目標：平台端完成客服單指派、處理、結案。
- 前置條件：已建立客服單且狀態為 `open`。
- 觸發條件：客服主管於平台端進行分派。
- 主要流程：
  1. 平台管理者檢視工單內容與優先級。
  2. 指派處理人員，狀態轉為 `in_progress`。
  3. 處理過程可補充回覆與內部備註。
  4. 完成處理，狀態轉為 `resolved`。
  5. 由提單者確認後轉 `closed`。
- 例外流程：
  - E1：超過 SLA 時間仍未完成，觸發逾期告警。
- 後置條件：完整保留處理歷程與稽核軌跡。
- 關聯頁面：3.平台端/tickets.html

---

## 8. 業務規則（BR）

- BR-ACC-001：OTP 單次有效期 5 分鐘；連續錯誤 5 次鎖定 15 分鐘。
- BR-ACC-002：邀請碼需具有效期限與使用次數上限。
- BR-ORD-001：訂單金額以建立訂單當下的價格與折扣快照為準。
- BR-ORD-002：訂單一旦進入 `processing` 不可由客戶端直接取消。
- BR-ORD-003：退款申請需由平台端審核，保留審核意見。
- BR-TIC-001：客服單需具備優先級（low/medium/high/urgent）。
- BR-TIC-002：客服單所有狀態變更需保留操作人、時間與原因。
- BR-AUD-001：管理端新增/編輯/刪除操作必須寫入操作日誌。

---

## 9. 狀態模型分析

### 9.1 訂單狀態機

| 目前狀態 | 事件 | 下一狀態 | 說明 |
|---|---|---|---|
| pending_payment | 付款成功 | paid | 金流回調成功 |
| pending_payment | 付款逾時 | cancelled | 逾時自動取消 |
| paid | 開始履約 | processing | 機構開始處理 |
| processing | 完成履約 | completed | 服務完成 |
| paid/processing | 申請退款 | refund_pending | 待平台審核 |
| refund_pending | 退款核准 | refunded | 金流退款完成 |
| refund_pending | 退款駁回 | processing/completed | 依實際履約狀態回復 |

### 9.2 客服單狀態機

| 目前狀態 | 事件 | 下一狀態 |
|---|---|---|
| open | 指派處理人員 | in_progress |
| in_progress | 處理完成 | resolved |
| resolved | 使用者確認 | closed |
| in_progress/resolved | 重新開啟 | in_progress |

### 9.3 綁定申請狀態

| 狀態 | 說明 |
|---|---|
| pending | 待審核 |
| approved | 審核通過 |
| rejected | 審核駁回 |
| expired | 逾時失效 |

---

## 10. 邏輯資料模型與資料字典

### 10.1 主要實體關聯（Logical ER）

1. `Organization` 1:N `OrgAdmin`
2. `Organization` 1:N `MemberBinding`
3. `User` 1:N `Order`
4. `Order` 1:N `OrderItem`
5. `ServiceCategory` 1:N `Service`
6. `Service` 1:N `OrderItem`
7. `Ticket` 1:N `TicketReply`
8. `Role` N:M `Permission`（透過 `RolePermission`）
9. `User` 1:N `AuditLog`

### 10.2 資料字典（核心表）

#### A. user

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| id | bigint | Y | 使用者主鍵 |
| role_type | varchar(20) | Y | member/org_admin/platform_admin |
| name | varchar(100) | Y | 姓名 |
| phone | varchar(20) | Y | 手機（唯一） |
| email | varchar(255) | N | 電子郵件 |
| status | varchar(20) | Y | active/inactive/locked |
| created_at | datetime | Y | 建立時間 |

#### B. organization

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| id | bigint | Y | 機構主鍵 |
| name | varchar(200) | Y | 機構名稱 |
| tax_id | varchar(20) | Y | 統一編號 |
| owner_name | varchar(100) | Y | 負責人 |
| contact_phone | varchar(20) | Y | 聯絡電話 |
| status | varchar(20) | Y | pending/active/inactive |
| revenue_ratio | decimal(5,2) | Y | 分潤比例 |

#### C. service

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| id | bigint | Y | 服務主鍵 |
| category_id | bigint | Y | 服務類別 |
| name | varchar(200) | Y | 服務名稱 |
| description | text | N | 服務說明 |
| base_price | decimal(12,2) | Y | 原價 |
| sale_price | decimal(12,2) | N | 促銷價 |
| status | varchar(20) | Y | on_shelf/off_shelf |

#### D. order / order_item

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| order.id | bigint | Y | 訂單主鍵 |
| order.member_id | bigint | Y | 下單會員 |
| order.org_id | bigint | Y | 所屬機構 |
| order.order_status | varchar(30) | Y | 訂單狀態 |
| order.payment_status | varchar(30) | Y | 付款狀態 |
| order.total_amount | decimal(12,2) | Y | 訂單總金額 |
| order_item.order_id | bigint | Y | 關聯訂單 |
| order_item.service_id | bigint | Y | 關聯服務 |
| order_item.qty | int | Y | 數量 |
| order_item.unit_price | decimal(12,2) | Y | 單價快照 |

#### E. ticket

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| id | bigint | Y | 客服單主鍵 |
| source_type | varchar(20) | Y | client/org |
| creator_id | bigint | Y | 建立者 |
| type | varchar(50) | Y | 問題類型 |
| priority | varchar(20) | Y | low/medium/high/urgent |
| status | varchar(20) | Y | open/in_progress/resolved/closed |
| assignee_id | bigint | N | 指派人員 |
| created_at | datetime | Y | 建立時間 |

#### F. audit_log

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| id | bigint | Y | 日誌主鍵 |
| operator_id | bigint | Y | 操作者 |
| module | varchar(50) | Y | 功能模組 |
| action | varchar(20) | Y | create/update/delete/login |
| target_id | varchar(100) | N | 目標資料鍵值 |
| before_json | json | N | 異動前快照 |
| after_json | json | N | 異動後快照 |
| ip | varchar(50) | Y | 來源 IP |
| created_at | datetime | Y | 操作時間 |

---

## 11. 介面與整合規格（分析層）

### 11.1 頁面模組對照

| 端別 | 頁面 | 模組 |
|---|---|---|
| 客戶端 | categories.html / service-detail.html | 服務瀏覽與下單 |
| 客戶端 | checkout.html / orders.html | 訂單交易 |
| 客戶端 | messages.html / chat.html | 訊息與通訊 |
| 機構端 | member-review.html / members.html | 綁定審核與個案管理 |
| 機構端 | orders.html | 分潤與訂單查詢 |
| 平台端 | organizations.html / org-review.html | 機構治理 |
| 平台端 | tickets.html | 客服單治理 |
| 平台端 | roles.html / logs.html | 權限與稽核 |

### 11.2 API 草案（供 SD 階段細化）

| API | 方法 | 說明 | 權限 |
|---|---|---|---|
| /api/v1/bindings/request-otp | POST | 送出綁定 OTP | ACT-C |
| /api/v1/bindings/verify | POST | 驗證 OTP 並建立綁定 | ACT-C |
| /api/v1/services | GET | 服務查詢（關鍵字/篩選） | Public/ACT-C |
| /api/v1/orders | POST | 建立訂單 | ACT-C |
| /api/v1/orders/{id}/pay-callback | POST | 金流回寫 | ACT-SYS |
| /api/v1/orders | GET | 訂單查詢 | ACT-C/ACT-O/ACT-P |
| /api/v1/member-bindings/{id}/review | PATCH | 綁定審核 | ACT-O |
| /api/v1/tickets | POST | 建立客服單 | ACT-C/ACT-O |
| /api/v1/tickets/{id}/assign | PATCH | 指派客服單 | ACT-P |
| /api/v1/tickets/{id}/status | PATCH | 更新客服單狀態 | ACT-P |
| /api/v1/admin/roles | CRUD | 角色權限管理 | ACT-P |
| /api/v1/admin/logs | GET | 操作日誌查詢 | ACT-P |

---

## 12. 權限矩陣（摘要）

| 模組 | 客戶端 ACT-C | 機構端 ACT-O | 平台端 ACT-P |
|---|---|---|---|
| 個案綁定 | C/R/U | R（審核） | R |
| 服務與購物車 | C/R/U | R | C/R/U/D |
| 訂單管理 | C/R（本人） | R（所屬機構） | C/R/U/D（全平台） |
| 公告管理 | R | C/R/U/D（機構） | C/R/U/D（平台） |
| 通訊功能 | C/R/U | C/R/U | R（監管） |
| 客服單 | C/R | C/R | C/R/U/D（分派與治理） |
| 角色權限 | - | C/R/U（機構內） | C/R/U/D（全平台） |
| 操作日誌 | - | R（機構範圍） | R（全平台） |

---

## 13. 非功能需求（NFR）

### 13.1 效能

- NFR-001：列表型 API，P95 回應時間 < 2 秒。
- NFR-002：下單與付款回寫具冪等（Idempotency）控制。

### 13.2 安全

- NFR-010：管理端需 RBAC 權限檢核。
- NFR-011：敏感資料（付款資訊、個資）需遮罩與加密。
- NFR-012：重要操作全量記錄於 audit_log。

### 13.3 可用性

- NFR-020：支援桌機與手機版操作。
- NFR-021：關鍵流程需有可理解錯誤訊息與復原路徑。

### 13.4 可維運性

- NFR-030：三端模組化維護（client/org/platform 分層）。
- NFR-031：版本可回溯，與 versions.json 對齊。

---

## 14. 錯誤碼與例外處理（建議）

| 錯誤碼 | 說明 | 處理方式 |
|---|---|---|
| E4001 | 邀請碼無效 | 顯示重新輸入並提供聯絡機構入口 |
| E4002 | OTP 驗證失敗 | 顯示剩餘次數，超限後鎖定 |
| E4101 | 無權限操作 | 顯示無權限訊息並導回可用頁 |
| E4201 | 訂單狀態衝突 | 重新同步訂單狀態後重試 |
| E5001 | 外部金流逾時 | 訂單保持待付款並可重試支付 |
| E5002 | 推播發送失敗 | 寫入重送佇列並告警 |

---

## 15. 需求追蹤矩陣（RTM）

| 需求 | Use Case | 頁面 | 資料實體 | API | 驗收測項 |
|---|---|---|---|---|---|
| FR-C-001 | UC-C-01 | 1.客戶端/caregiver-binding.html | user、member_binding | /bindings/request-otp、/bindings/verify | AT-C-01 |
| FR-C-004 | UC-C-02 | 1.客戶端/checkout.html、orders.html | order、order_item | /orders、/orders/{id}/pay-callback | AT-C-02 |
| FR-O-001 | UC-O-01 | 2.機構端/member-review.html | member_binding、audit_log | /member-bindings/{id}/review | AT-O-01 |
| FR-O-003 | UC-O-02 | 2.機構端/orders.html | order、organization | /orders | AT-O-02 |
| FR-P-001 | UC-P-01 | 3.平台端/org-review.html | organization、audit_log | /admin/organizations/review | AT-P-01 |
| FR-P-006 | UC-P-02 | 3.平台端/tickets.html | ticket、ticket_reply | /tickets/{id}/assign、/tickets/{id}/status | AT-P-02 |
| FR-P-007 | UC-P-03 | 3.平台端/roles.html | role、permission | /admin/roles | AT-P-03 |

---

## 16. 驗收條件（AT）

- AT-C-01：輸入有效邀請碼 + 正確 OTP，綁定成功且可見於綁定列表。
- AT-C-02：建立訂單後付款成功，訂單狀態可由 pending_payment 轉為 paid。
- AT-O-01：機構端可完成綁定申請之核准/駁回，並寫入審核紀錄。
- AT-O-02：機構端可依日期與狀態篩選訂單，並檢視分潤明細。
- AT-P-01：平台端可完成機構審核並可啟用/停用。
- AT-P-02：客服單可完成指派、處理、結案全流程，逾時可告警。
- AT-P-03：角色權限調整後，即時影響可見功能選單與 API 存取。

---

## 17. 假設與待確認事項

1. 金流與簡訊供應商尚未定版，API 欄位與簽章規則待補。
2. 退款責任歸屬（機構/平台）需再確認審核責任切分。
3. 客服 SLA（不同優先級）需由營運單位定義具體門檻。
4. 報表匯出欄位與財務口徑需由財務單位確認。

---

## 18. 後續輸出建議（銜接 SD）

1. 產出 API 詳細介面契約（Request/Response Schema）。
2. 產出資料庫實體設計（DDL、索引、唯一鍵、外鍵）。
3. 產出序列圖（綁定、下單付款、客服分派）。
4. 產出權限碼表與選單權限對照。

---

## 19. 附錄：頁面盤點（依現況）

### 19.1 客戶端

- index.html
- categories.html
- search.html
- service-detail.html
- checkout.html
- orders.html / order-detail.html
- messages.html / message-detail.html
- announcements.html / announcement-detail.html
- chat.html / chat-detail.html
- profile.html / edit-profile.html
- caregiver-binding.html
- contact.html / faq.html
- promotions.html
- ticket-detail.html

### 19.2 機構端

- index.html
- members.html
- member-binding.html
- member-review.html
- orders.html
- announcements.html
- chat.html
- admins.html
- organization.html

### 19.3 平台端

- index.html
- organizations.html
- org-review.html
- members.html
- orders.html
- categories.html
- services.html
- announcements.html
- tickets.html
- admins.html
- roles.html
- logs.html
