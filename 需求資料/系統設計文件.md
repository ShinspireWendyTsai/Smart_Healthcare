# 全方位智慧貼身照護平台－系統設計文件（SD）

## 1. 文件控管

| 項目 | 內容 |
|---|---|
| 文件名稱 | 全方位智慧貼身照護平台－系統設計文件 |
| 文件代碼 | SD-SMART-HEALTHCARE-001 |
| 文件版本 | v1.0 |
| 文件日期 | 2026-02-26 |
| 上游文件 | 需求資料/系統規格文件.md（SA v2.0） |
| 文件目的 | 將 SA 需求轉為可實作的系統架構、API 契約與資料庫設計 |

### 1.1 與 SA 追溯關係

| SA 區塊 | SD 對應章節 |
|---|---|
| FR-C-001 ~ FR-C-007 | 5 模組設計、6 API 設計、7 DB 設計 |
| FR-O-001 ~ FR-O-006 | 5 模組設計、6 API 設計、7 DB 設計 |
| FR-P-001 ~ FR-P-008 | 5 模組設計、6 API 設計、7 DB 設計、8 安全與稽核 |
| UC-C/O/P | 9 序列流程設計 |
| NFR-001 ~ NFR-031 | 10 非功能設計 |

---

## 2. 設計目標與原則

### 2.1 設計目標

1. 支援三端（客戶端/機構端/平台端）一致的服務層與資料層。
2. 提供可擴充的 RBAC 權限控管與稽核能力。
3. 提供交易型流程（綁定、下單、客服）的一致性與可追蹤性。
4. API 契約穩定、可版本化、可測試。

### 2.2 設計原則

- 分層架構：前端、API、Domain Service、Infrastructure、DB 分離。
- 模組內聚：依業務域拆分模組，避免單體巨型服務邏輯。
- 追溯一致：所有核心功能可回溯到 FR 與 UC。
- 安全預設：管理端與敏感操作預設最小權限。
- 可觀測性：每個關鍵流程有日誌、指標、追蹤 ID。

---

## 3. 系統總體架構

### 3.1 邏輯架構

1. Presentation Layer
   - 客戶端前端（1.客戶端）
   - 機構端前端（2.機構端）
   - 平台端前端（3.平台端）
2. API Layer
   - REST API（/api/v1）
   - JWT 驗證與 RBAC 中介層
3. Domain Services
   - Identity Service
   - Binding Service
   - Catalog Service
   - Order Service
   - Ticket Service
   - Announcement Service
   - Messaging Service
   - Governance Service（機構/會員/權限/日誌）
4. Integration Layer
   - OTP Adapter
   - Payment Adapter
   - Notification Adapter
5. Data Layer
   - MySQL 8（交易資料）
   - 可選：Redis（OTP、暫存、限流）

### 3.2 實體部署建議（環境分層）

- DEV：開發環境（可共享 DB instance，不共享 schema）。
- SIT：整合測試環境（外部服務使用 sandbox）。
- UAT：驗收環境（資料脫敏）。
- PROD：正式環境（高可用、備援、監控、告警）。

---

## 4. 模組設計

### 4.1 Identity & Access 模組

- 責任：登入、Token 簽發、角色授權、權限檢核。
- 主要實體：users、roles、permissions、user_roles、role_permissions。
- 關聯 FR：FR-P-007、FR-P-008。

### 4.2 Binding 模組

- 責任：邀請碼綁定、OTP 發送與驗證、機構審核。
- 主要實體：member_bindings、otp_records。
- 關聯 FR：FR-C-001、FR-O-001。

### 4.3 Catalog 模組

- 責任：類別管理、服務管理、上架下架與查詢。
- 主要實體：service_categories、services。
- 關聯 FR：FR-C-003、FR-P-004。

### 4.4 Order 模組

- 責任：建立訂單、付款回寫、訂單狀態轉移、退款審核。
- 主要實體：orders、order_items、payment_events、order_status_logs。
- 關聯 FR：FR-C-004、FR-O-003、FR-P-003。

### 4.5 Ticket 模組

- 責任：客服提單、分派、狀態流轉、回覆與 SLA。
- 主要實體：tickets、ticket_replies。
- 關聯 FR：FR-C-007、FR-P-006。

### 4.6 Announcement 模組

- 責任：平台/機構公告管理、投放對象設定、發布排程。
- 主要實體：announcements。
- 關聯 FR：FR-O-004、FR-P-005。

### 4.7 Messaging 模組

- 責任：聊天室、訊息傳遞、已讀回條。
- 主要實體：chat_rooms、messages。
- 關聯 FR：FR-C-006、FR-O-005。

### 4.8 Governance 模組

- 責任：機構治理、會員治理、操作日誌、異常檢核。
- 主要實體：organizations、audit_logs。
- 關聯 FR：FR-P-001、FR-P-002、FR-P-008。

---

## 5. API 設計規格

## 5.1 通用規範

- Base URL：/api/v1
- 認證方式：Bearer JWT
- 內容格式：application/json
- 時區：UTC+8（寫入 DB 使用 UTC，回傳可轉換）
- 分頁欄位：page、pageSize、total、items
- 追蹤欄位：x-request-id（Header）

### 5.2 回應包裝格式

| 欄位 | 型別 | 說明 |
|---|---|---|
| success | boolean | 是否成功 |
| code | string | 業務碼（如 OK、E4001） |
| message | string | 顯示訊息 |
| data | object | 回傳資料 |
| traceId | string | 追蹤識別 |

### 5.3 核心 API 詳規

#### A. 綁定流程

##### POST /api/v1/bindings/request-otp

- 權限：ACT-C
- 用途：送出邀請碼後，要求系統發送 OTP

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| inviteCode | string | Y | 邀請碼 |
| phone | string | Y | 驗證手機 |

Response data 欄位

| 欄位 | 型別 | 說明 |
|---|---|---|
| requestId | string | OTP 請求識別碼 |
| expiresInSec | number | OTP 有效秒數 |
| retryAfterSec | number | 下次可重送秒數 |

##### POST /api/v1/bindings/verify

- 權限：ACT-C
- 用途：驗證 OTP 並建立綁定

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| requestId | string | Y | OTP 請求識別碼 |
| otpCode | string | Y | 驗證碼 |

Response data 欄位

| 欄位 | 型別 | 說明 |
|---|---|---|
| bindingId | number | 綁定主鍵 |
| status | string | active/pending |

#### B. 服務查詢

##### GET /api/v1/services

- 權限：Public/ACT-C
- 用途：服務列表查詢

Query 參數

| 參數 | 型別 | 必填 | 說明 |
|---|---|---|---|
| keyword | string | N | 關鍵字 |
| categoryId | number | N | 類別 |
| minPrice | number | N | 最低價格 |
| maxPrice | number | N | 最高價格 |
| sortBy | string | N | price/newest/popular |
| page | number | N | 頁碼 |
| pageSize | number | N | 每頁筆數 |

#### C. 訂單交易

##### POST /api/v1/orders

- 權限：ACT-C
- 用途：建立訂單

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| memberId | number | Y | 下單會員 |
| orgId | number | Y | 所屬機構 |
| idempotencyKey | string | Y | 防重複提交鍵值 |
| items | array | Y | 訂單品項 |
| paymentMethod | string | Y | card/linepay/bank |
| couponCode | string | N | 優惠碼 |

items 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| serviceId | number | Y | 服務 ID |
| qty | number | Y | 數量 |
| spec | string | N | 規格描述 |

Response data 欄位

| 欄位 | 型別 | 說明 |
|---|---|---|
| orderId | number | 訂單主鍵 |
| orderNo | string | 訂單編號 |
| orderStatus | string | pending_payment |
| paymentUrl | string | 金流導轉網址 |

##### POST /api/v1/orders/{id}/pay-callback

- 權限：ACT-SYS（簽章驗證）
- 用途：接收金流回寫

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| providerTxnId | string | Y | 第三方交易編號 |
| paidAmount | number | Y | 付款金額 |
| paidAt | datetime | Y | 付款時間 |
| result | string | Y | success/fail |
| signature | string | Y | 回調簽章 |

##### GET /api/v1/orders

- 權限：ACT-C / ACT-O / ACT-P（依資料範圍）
- 用途：查詢訂單列表

Query 參數

| 參數 | 型別 | 必填 | 說明 |
|---|---|---|---|
| status | string | N | 訂單狀態 |
| paymentStatus | string | N | 付款狀態 |
| memberId | number | N | 會員（機構/平台可用） |
| orgId | number | N | 機構（平台可用） |
| dateFrom | date | N | 起始日期 |
| dateTo | date | N | 結束日期 |

#### D. 機構綁定審核

##### PATCH /api/v1/member-bindings/{id}/review

- 權限：ACT-O
- 用途：審核綁定申請

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| action | string | Y | approve/reject |
| comment | string | N | 審核備註 |

#### E. 客服流程

##### POST /api/v1/tickets

- 權限：ACT-C / ACT-O
- 用途：建立客服單

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| sourceType | string | Y | client/org |
| type | string | Y | 問題類型 |
| subject | string | Y | 標題 |
| content | string | Y | 內容 |
| priority | string | Y | low/medium/high/urgent |

##### PATCH /api/v1/tickets/{id}/assign

- 權限：ACT-P
- 用途：指派處理人員

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| assigneeId | number | Y | 指派人員 ID |
| dueAt | datetime | N | 目標完成時間 |

##### PATCH /api/v1/tickets/{id}/status

- 權限：ACT-P
- 用途：更新工單狀態

Request 欄位

| 欄位 | 型別 | 必填 | 說明 |
|---|---|---|---|
| status | string | Y | in_progress/resolved/closed |
| note | string | N | 處理備註 |

#### F. 權限與稽核

##### GET /api/v1/admin/roles
##### POST /api/v1/admin/roles
##### PATCH /api/v1/admin/roles/{id}
##### DELETE /api/v1/admin/roles/{id}

- 權限：ACT-P
- 用途：角色與權限維護

##### GET /api/v1/admin/logs

- 權限：ACT-P
- 用途：操作日誌查詢

Query 參數

| 參數 | 型別 | 必填 | 說明 |
|---|---|---|---|
| operatorId | number | N | 操作者 |
| module | string | N | 模組 |
| action | string | N | 操作類型 |
| dateFrom | date | N | 起日 |
| dateTo | date | N | 迄日 |

---

## 6. 資料庫實體設計（MySQL 8.0）

### 6.1 設計原則

- 主鍵：BIGINT UNSIGNED AUTO_INCREMENT
- 時間欄位：created_at、updated_at（UTC）
- 交易欄位：金額使用 DECIMAL(12,2)
- 多值資料：優先正規化，必要時使用 JSON
- 稽核需求：關鍵表維護 status log 或 audit log

### 6.2 DDL 草案

```sql
CREATE DATABASE IF NOT EXISTS smart_healthcare
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_0900_ai_ci;

USE smart_healthcare;

CREATE TABLE users (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  role_type VARCHAR(20) NOT NULL,
  name VARCHAR(100) NOT NULL,
  phone VARCHAR(20) NOT NULL,
  email VARCHAR(255) NULL,
  password_hash VARCHAR(255) NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_users_phone (phone),
  KEY idx_users_role_status (role_type, status)
);

CREATE TABLE organizations (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  tax_id VARCHAR(20) NOT NULL,
  owner_name VARCHAR(100) NOT NULL,
  contact_phone VARCHAR(20) NOT NULL,
  email VARCHAR(255) NULL,
  address VARCHAR(255) NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  revenue_ratio DECIMAL(5,2) NOT NULL DEFAULT 0.00,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_organizations_tax_id (tax_id),
  KEY idx_organizations_status (status)
);

CREATE TABLE roles (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  scope_type VARCHAR(20) NOT NULL,
  name VARCHAR(100) NOT NULL,
  description VARCHAR(255) NULL,
  role_level INT NOT NULL DEFAULT 1,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_roles_scope_name (scope_type, name)
);

CREATE TABLE permissions (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  module_code VARCHAR(50) NOT NULL,
  action_code VARCHAR(20) NOT NULL,
  description VARCHAR(255) NULL,
  UNIQUE KEY uk_permissions_module_action (module_code, action_code)
);

CREATE TABLE role_permissions (
  role_id BIGINT UNSIGNED NOT NULL,
  permission_id BIGINT UNSIGNED NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (role_id, permission_id),
  CONSTRAINT fk_rp_role FOREIGN KEY (role_id) REFERENCES roles(id),
  CONSTRAINT fk_rp_permission FOREIGN KEY (permission_id) REFERENCES permissions(id)
);

CREATE TABLE user_roles (
  user_id BIGINT UNSIGNED NOT NULL,
  role_id BIGINT UNSIGNED NOT NULL,
  org_id BIGINT UNSIGNED NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (user_id, role_id, org_id),
  CONSTRAINT fk_ur_user FOREIGN KEY (user_id) REFERENCES users(id),
  CONSTRAINT fk_ur_role FOREIGN KEY (role_id) REFERENCES roles(id),
  CONSTRAINT fk_ur_org FOREIGN KEY (org_id) REFERENCES organizations(id)
);

CREATE TABLE member_bindings (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  member_id BIGINT UNSIGNED NOT NULL,
  org_id BIGINT UNSIGNED NOT NULL,
  invite_code VARCHAR(50) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  reviewer_id BIGINT UNSIGNED NULL,
  reviewed_at DATETIME NULL,
  expire_at DATETIME NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY idx_member_bindings_member (member_id),
  KEY idx_member_bindings_org_status (org_id, status),
  KEY idx_member_bindings_invite_code (invite_code),
  CONSTRAINT fk_mb_member FOREIGN KEY (member_id) REFERENCES users(id),
  CONSTRAINT fk_mb_org FOREIGN KEY (org_id) REFERENCES organizations(id),
  CONSTRAINT fk_mb_reviewer FOREIGN KEY (reviewer_id) REFERENCES users(id)
);

CREATE TABLE otp_records (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  request_id VARCHAR(64) NOT NULL,
  phone VARCHAR(20) NOT NULL,
  otp_hash VARCHAR(255) NOT NULL,
  purpose VARCHAR(30) NOT NULL,
  expired_at DATETIME NOT NULL,
  verified_at DATETIME NULL,
  failed_count INT NOT NULL DEFAULT 0,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_otp_request_id (request_id),
  KEY idx_otp_phone_purpose (phone, purpose)
);

CREATE TABLE service_categories (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  parent_id BIGINT UNSIGNED NULL,
  name VARCHAR(100) NOT NULL,
  description VARCHAR(255) NULL,
  sort_order INT NOT NULL DEFAULT 0,
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY idx_service_categories_parent (parent_id),
  KEY idx_service_categories_status_sort (status, sort_order),
  CONSTRAINT fk_sc_parent FOREIGN KEY (parent_id) REFERENCES service_categories(id)
);

CREATE TABLE services (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  category_id BIGINT UNSIGNED NOT NULL,
  org_id BIGINT UNSIGNED NULL,
  name VARCHAR(200) NOT NULL,
  description TEXT NULL,
  base_price DECIMAL(12,2) NOT NULL,
  sale_price DECIMAL(12,2) NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'on_shelf',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY idx_services_category_status (category_id, status),
  KEY idx_services_org (org_id),
  CONSTRAINT fk_services_category FOREIGN KEY (category_id) REFERENCES service_categories(id),
  CONSTRAINT fk_services_org FOREIGN KEY (org_id) REFERENCES organizations(id)
);

CREATE TABLE orders (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  order_no VARCHAR(40) NOT NULL,
  member_id BIGINT UNSIGNED NOT NULL,
  org_id BIGINT UNSIGNED NOT NULL,
  order_status VARCHAR(30) NOT NULL DEFAULT 'pending_payment',
  payment_status VARCHAR(30) NOT NULL DEFAULT 'unpaid',
  payment_method VARCHAR(30) NOT NULL,
  currency CHAR(3) NOT NULL DEFAULT 'TWD',
  subtotal_amount DECIMAL(12,2) NOT NULL,
  discount_amount DECIMAL(12,2) NOT NULL DEFAULT 0.00,
  shipping_fee DECIMAL(12,2) NOT NULL DEFAULT 0.00,
  total_amount DECIMAL(12,2) NOT NULL,
  idempotency_key VARCHAR(80) NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_orders_order_no (order_no),
  UNIQUE KEY uk_orders_idempotency_key (idempotency_key),
  KEY idx_orders_member_created (member_id, created_at),
  KEY idx_orders_org_created (org_id, created_at),
  KEY idx_orders_status (order_status, payment_status),
  CONSTRAINT fk_orders_member FOREIGN KEY (member_id) REFERENCES users(id),
  CONSTRAINT fk_orders_org FOREIGN KEY (org_id) REFERENCES organizations(id)
);

CREATE TABLE order_items (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  order_id BIGINT UNSIGNED NOT NULL,
  service_id BIGINT UNSIGNED NOT NULL,
  service_name_snapshot VARCHAR(200) NOT NULL,
  spec_snapshot VARCHAR(255) NULL,
  qty INT NOT NULL,
  unit_price DECIMAL(12,2) NOT NULL,
  line_total DECIMAL(12,2) NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  KEY idx_order_items_order (order_id),
  CONSTRAINT fk_order_items_order FOREIGN KEY (order_id) REFERENCES orders(id),
  CONSTRAINT fk_order_items_service FOREIGN KEY (service_id) REFERENCES services(id)
);

CREATE TABLE payment_events (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  order_id BIGINT UNSIGNED NOT NULL,
  provider_name VARCHAR(50) NOT NULL,
  provider_txn_id VARCHAR(100) NOT NULL,
  event_type VARCHAR(30) NOT NULL,
  event_result VARCHAR(20) NOT NULL,
  raw_payload JSON NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_payment_events_provider_txn (provider_name, provider_txn_id, event_type),
  KEY idx_payment_events_order (order_id),
  CONSTRAINT fk_payment_events_order FOREIGN KEY (order_id) REFERENCES orders(id)
);

CREATE TABLE order_status_logs (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  order_id BIGINT UNSIGNED NOT NULL,
  from_status VARCHAR(30) NULL,
  to_status VARCHAR(30) NOT NULL,
  operator_id BIGINT UNSIGNED NULL,
  reason VARCHAR(255) NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  KEY idx_order_status_logs_order (order_id, created_at),
  CONSTRAINT fk_osl_order FOREIGN KEY (order_id) REFERENCES orders(id),
  CONSTRAINT fk_osl_operator FOREIGN KEY (operator_id) REFERENCES users(id)
);

CREATE TABLE announcements (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  source_type VARCHAR(20) NOT NULL,
  org_id BIGINT UNSIGNED NULL,
  title VARCHAR(200) NOT NULL,
  content MEDIUMTEXT NOT NULL,
  level VARCHAR(20) NOT NULL DEFAULT 'normal',
  target_type VARCHAR(30) NOT NULL,
  publish_at DATETIME NULL,
  expire_at DATETIME NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'draft',
  created_by BIGINT UNSIGNED NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY idx_announcements_source_status (source_type, status),
  KEY idx_announcements_publish (publish_at, expire_at),
  CONSTRAINT fk_announcements_org FOREIGN KEY (org_id) REFERENCES organizations(id),
  CONSTRAINT fk_announcements_creator FOREIGN KEY (created_by) REFERENCES users(id)
);

CREATE TABLE tickets (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ticket_no VARCHAR(40) NOT NULL,
  source_type VARCHAR(20) NOT NULL,
  creator_id BIGINT UNSIGNED NOT NULL,
  org_id BIGINT UNSIGNED NULL,
  type VARCHAR(50) NOT NULL,
  subject VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  priority VARCHAR(20) NOT NULL DEFAULT 'medium',
  status VARCHAR(20) NOT NULL DEFAULT 'open',
  assignee_id BIGINT UNSIGNED NULL,
  due_at DATETIME NULL,
  closed_at DATETIME NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_tickets_ticket_no (ticket_no),
  KEY idx_tickets_status_priority (status, priority),
  KEY idx_tickets_assignee (assignee_id),
  KEY idx_tickets_creator (creator_id),
  CONSTRAINT fk_tickets_creator FOREIGN KEY (creator_id) REFERENCES users(id),
  CONSTRAINT fk_tickets_assignee FOREIGN KEY (assignee_id) REFERENCES users(id),
  CONSTRAINT fk_tickets_org FOREIGN KEY (org_id) REFERENCES organizations(id)
);

CREATE TABLE ticket_replies (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ticket_id BIGINT UNSIGNED NOT NULL,
  replier_id BIGINT UNSIGNED NOT NULL,
  is_internal TINYINT(1) NOT NULL DEFAULT 0,
  content TEXT NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  KEY idx_ticket_replies_ticket_created (ticket_id, created_at),
  CONSTRAINT fk_ticket_replies_ticket FOREIGN KEY (ticket_id) REFERENCES tickets(id),
  CONSTRAINT fk_ticket_replies_replier FOREIGN KEY (replier_id) REFERENCES users(id)
);

CREATE TABLE chat_rooms (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  room_type VARCHAR(20) NOT NULL,
  member_id BIGINT UNSIGNED NULL,
  org_id BIGINT UNSIGNED NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  KEY idx_chat_rooms_member_org (member_id, org_id),
  CONSTRAINT fk_chat_rooms_member FOREIGN KEY (member_id) REFERENCES users(id),
  CONSTRAINT fk_chat_rooms_org FOREIGN KEY (org_id) REFERENCES organizations(id)
);

CREATE TABLE messages (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  room_id BIGINT UNSIGNED NOT NULL,
  sender_id BIGINT UNSIGNED NOT NULL,
  message_type VARCHAR(20) NOT NULL DEFAULT 'text',
  content TEXT NULL,
  attachment_url VARCHAR(500) NULL,
  read_at DATETIME NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  KEY idx_messages_room_created (room_id, created_at),
  KEY idx_messages_sender (sender_id),
  CONSTRAINT fk_messages_room FOREIGN KEY (room_id) REFERENCES chat_rooms(id),
  CONSTRAINT fk_messages_sender FOREIGN KEY (sender_id) REFERENCES users(id)
);

CREATE TABLE audit_logs (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  operator_id BIGINT UNSIGNED NOT NULL,
  module_code VARCHAR(50) NOT NULL,
  action_code VARCHAR(20) NOT NULL,
  target_type VARCHAR(50) NULL,
  target_id VARCHAR(100) NULL,
  before_json JSON NULL,
  after_json JSON NULL,
  request_id VARCHAR(64) NULL,
  ip VARCHAR(50) NOT NULL,
  user_agent VARCHAR(500) NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  KEY idx_audit_logs_operator_created (operator_id, created_at),
  KEY idx_audit_logs_module_action_created (module_code, action_code, created_at),
  CONSTRAINT fk_audit_logs_operator FOREIGN KEY (operator_id) REFERENCES users(id)
);
```

---

## 7. 權限模型與授權流程

### 7.1 RBAC 模型

1. 使用者可持有多角色（user_roles）。
2. 角色可包含多權限（role_permissions）。
3. 權限粒度：module_code + action_code。
4. 管理端 API 一律經過 RBAC 中介層檢核。

### 7.2 權限碼建議

| module_code | action_code |
|---|---|
| ORG_REVIEW | READ/APPROVE/REJECT |
| ORDER | READ/UPDATE/REFUND |
| TICKET | READ/ASSIGN/UPDATE/CLOSE |
| ROLE | READ/CREATE/UPDATE/DELETE |
| AUDIT_LOG | READ |

---

## 8. 安全、稽核與合規設計

### 8.1 安全控制

- API 驗證：JWT + Token 過期 + Refresh Token。
- 敏感資料：手機、Email 顯示遮罩；密碼雜湊儲存。
- 外部回調：簽章驗證 + IP 白名單 + 重放防護。
- 交易防重：idempotency_key、provider_txn_id 唯一索引。

### 8.2 稽核控制

- 管理端 C/U/D 必寫 audit_logs。
- 訂單與客服單狀態變更需有 status log。
- 每個 API 請求具 request_id 可追溯。

---

## 9. 關鍵流程序列設計

### 9.1 綁定流程（UC-C-01）

1. 前端送 inviteCode/phone 至 request-otp。
2. Binding Service 檢核邀請碼，建立 otp_records。
3. OTP Adapter 發送簡訊。
4. 使用者輸入 otpCode 呼叫 verify。
5. 驗證成功後寫 member_bindings 並回傳綁定結果。

### 9.2 下單付款流程（UC-C-02）

1. 前端送出建立訂單（含 idempotency_key）。
2. Order Service 交易建立 orders/order_items。
3. 回傳 paymentUrl 導向金流。
4. 金流呼叫 pay-callback。
5. 系統更新 orders 狀態、寫 payment_events 與 order_status_logs。
6. 發送通知給客戶端與機構端。

### 9.3 客服單流程（UC-P-02）

1. 建單：建立 tickets。
2. 指派：更新 assignee_id、status=in_progress。
3. 回覆：寫 ticket_replies（可區分內外部備註）。
4. 完成：status=resolved/closed，寫 audit_logs。

---

## 10. 非功能設計（對應 NFR）

### 10.1 效能

- 訂單、查詢 API 需有適當索引與分頁上限。
- 公告、服務列表可加入快取（TTL 60~180 秒）。
- API 逾時建議：讀取 3 秒、交易 8 秒、外部回調 10 秒。

### 10.2 可用性

- 所有關鍵交易提供可重試設計。
- 外部服務異常時採降級策略（先記錄，後補償）。

### 10.3 可維運性

- 日誌分級：ERROR/WARN/INFO。
- 監控指標：API 成功率、P95、付款成功率、工單 SLA 達成率。

---

## 11. 設計追蹤矩陣（SD-RTM）

| FR | 模組 | 主要 API | 主要資料表 |
|---|---|---|---|
| FR-C-001 | Binding | /bindings/request-otp、/bindings/verify | member_bindings、otp_records |
| FR-C-004 | Order | /orders、/orders/{id}/pay-callback | orders、order_items、payment_events |
| FR-O-001 | Binding | /member-bindings/{id}/review | member_bindings、audit_logs |
| FR-O-003 | Order | /orders | orders、order_items |
| FR-P-001 | Governance | /admin/organizations/review（SD 實作） | organizations、audit_logs |
| FR-P-006 | Ticket | /tickets、/tickets/{id}/assign、/tickets/{id}/status | tickets、ticket_replies |
| FR-P-007 | Identity & Access | /admin/roles | roles、permissions、role_permissions |
| FR-P-008 | Governance | /admin/logs | audit_logs |

---

## 12. 版本與遷移策略

### 12.1 API 版本策略

- 採 URI 版號：/api/v1
- 破壞性調整升級為 /api/v2
- 舊版 API 至少保留一個完整版本週期

### 12.2 DB Migration 策略

- 採遷移腳本管理（向上/向下腳本）。
- 每次發版前執行 schema drift 檢查。
- 生產環境 DDL 需經審核窗口與備援演練。

---

## 13. 後續交付清單

1. OpenAPI 3.1 文件（依本文件 API 欄位展開）。
2. 實際 migration SQL 檔案與 seed 腳本。
3. 權限碼表（Permission Catalog）與角色預設模板。
4. 端到端測試案例（綁定、下單付款、客服分派）。

---

## 14. 待確認事項

1. 外部金流實際欄位與簽章規格。
2. OTP 供應商與發送限制策略。
3. 客服 SLA 門檻（依優先級）最終值。
4. 訂單取消與退款的責任邊界（機構端/平台端）。
