# 全方位智慧貼身照護平台－客戶端規格文件

## 1. 文件控管

| 項目 | 內容 |
|---|---|
| 文件名稱 | 全方位智慧貼身照護平台－客戶端規格文件 |
| 文件版本 | v1.0 |
| 文件日期 | 2026-02-26 |
| 整理來源 | 需求資料/系統規格文件.md（SA+SD 整併版） |
| 適用範圍 | 1.客戶端 前端頁面與 ACT-C 相關 API/資料模型 |

---

## 2. 需求規格（SA）

### 2.1 角色與權責

| 角色代碼 | 角色名稱 | 客戶端關聯責任 |
|---|---|---|
| ACT-C | 客戶端使用者（個案/家屬） | 綁定、下單、查單、通訊、提單 |
| ACT-O | 機構管理者 | 綁定審核、訂單履約、公告/通訊協作 |
| ACT-P | 平台管理者 | 客服治理、退款審核、稽核監管 |

### 2.2 功能需求（FR-C）

- FR-C-001：邀請碼綁定與 OTP 驗證。
- FR-C-002：家人/關懷者綁定與解除。
- FR-C-003：服務瀏覽、搜尋、篩選、排序。
- FR-C-004：購物車、結帳、付款、訂單追蹤。
- FR-C-005：通知中心（未讀、已讀、刪除、跳轉）。
- FR-C-006：即時通訊與訊息查詢。
- FR-C-007：客服提單、查詢、回覆通知。

### 2.3 Use Case（客戶端）

| UC 編號 | 名稱 | 關聯需求 |
|---|---|---|
| UC-C-01 | 個案帳號綁定 | FR-C-001 |
| UC-C-02 | 建立訂單與付款 | FR-C-004 |
| UC-C-03 | 提交客服單 | FR-C-007 |

#### UC-C-01 個案帳號綁定

- 前置：使用者已登入，邀請碼有效。
- 主流程：驗證邀請碼 → 發送 OTP → 驗證 OTP → 建立綁定 → 通知機構。
- 例外：邀請碼失效、OTP 超次鎖定。
- 後置：綁定 `active`，寫入稽核日誌。

#### UC-C-02 建立訂單與付款

- 前置：商品上架且購物車非空。
- 主流程：檢核價格/折扣 → 建立 `pending_payment` 訂單 → 金流交易 → 成功轉 `paid` → 通知。
- 例外：付款失敗留在 `pending_payment`；逾時轉 `cancelled`。
- 後置：客戶端與機構端可追蹤訂單狀態。

### 2.4 業務規則（客戶端關聯）

- BR-ACC-001：OTP 有效 5 分鐘，連續錯誤 5 次鎖定 15 分鐘。
- BR-ACC-002：邀請碼具有效期與使用次數上限。
- BR-ORD-001：訂單金額以建立當下價格/折扣快照為準。
- BR-ORD-002：訂單進入 `processing` 後不可由客戶端直接取消。
- BR-TIC-001：客服單需有優先級（low/medium/high/urgent）。

### 2.5 狀態模型（客戶端可見）

#### 訂單狀態

`pending_payment` → `paid` → `processing` → `completed`，並支援 `refund_pending` → `refunded` 或回復至履約狀態。

#### 客服單狀態

`open` → `in_progress` → `resolved` → `closed`（可重開）。

### 2.6 權限摘要（ACT-C）

| 模組 | 權限 |
|---|---|
| 個案綁定 | C/R/U |
| 服務與購物車 | C/R/U |
| 訂單管理 | C/R（本人） |
| 公告 | R |
| 通訊 | C/R/U |
| 客服單 | C/R |

### 2.7 非功能需求（客戶端關聯）

- NFR-001：列表 API P95 < 2 秒。
- NFR-002：下單與付款回寫需冪等控制。
- NFR-020：支援桌機與手機版。
- NFR-021：關鍵流程需可理解錯誤與復原路徑。

### 2.8 驗收條件（AT-C）

- AT-C-01：有效邀請碼 + 正確 OTP 可完成綁定。
- AT-C-02：付款成功後訂單由 `pending_payment` 轉為 `paid`。

### 2.9 頁面盤點（客戶端）

- index.html
- categories.html
- search.html
- service-detail.html
- checkout.html
- orders.html / order-detail.html
- messages.html / message-detail.html
- announcements.html / announcement-detail.html
- chat.html / chat-detail.html
- profile.html / edit-profile.html
- caregiver-binding.html
- contact.html / faq.html
- promotions.html
- ticket-detail.html

---

## 3. 系統設計（SD）

### 3.1 設計目標

1. 支援綁定、查詢、下單、客服的一致流程。
2. 提供穩定 API 契約供前端整合。
3. 關鍵交易具 traceId/requestId 可追蹤性。

### 3.2 架構定位

- Presentation：1.客戶端
- API Layer：`/api/v1` + JWT
- Domain Services：Binding、Catalog、Order、Ticket、Messaging
- Integration：OTP / Payment / Notification Adapter
- Data：MySQL 8（可選 Redis）

### 3.3 模組設計（客戶端主關聯）

| 模組 | 職責 | 主要資料表 |
|---|---|---|
| Binding | 邀請碼與 OTP 綁定 | member_bindings、otp_records |
| Catalog | 服務查詢與篩選 | service_categories、services |
| Order | 建單、付款導轉、狀態追蹤 | orders、order_items、payment_events、order_status_logs |
| Ticket/Messaging | 客服提單、回覆、通訊 | tickets、ticket_replies、chat_rooms、messages |

### 3.4 API 規格（客戶端）

#### 共通規範

- Base URL：`/api/v1`
- 認證：Bearer JWT
- 格式：application/json
- 分頁：page、pageSize、total、items
- 追蹤：x-request-id

#### 核心 API

| API | 方法 | 權限 | 用途 |
|---|---|---|---|
| /api/v1/bindings/request-otp | POST | ACT-C | 送出綁定 OTP |
| /api/v1/bindings/verify | POST | ACT-C | 驗證 OTP 並建立綁定 |
| /api/v1/services | GET | Public/ACT-C | 服務列表查詢 |
| /api/v1/orders | POST | ACT-C | 建立訂單 |
| /api/v1/orders | GET | ACT-C/ACT-O/ACT-P | 訂單查詢 |
| /api/v1/tickets | POST | ACT-C/ACT-O | 建立客服單 |

### 3.5 關鍵流程序列

#### 綁定流程（UC-C-01）

1. 前端送 `inviteCode/phone` 至 request-otp。
2. 建立 otp_records 並透過 OTP Adapter 發送。
3. 前端送 `requestId/otpCode` 至 verify。
4. 驗證成功後建立 member_bindings。

#### 下單付款流程（UC-C-02）

1. 建立訂單（含 `idempotency_key`）。
2. 建立 orders/order_items 並回傳 paymentUrl。
3. 金流回調後更新狀態，寫 payment_events/order_status_logs。

### 3.6 非功能設計（實作向）

- 訂單/查詢 API 需索引與分頁上限。
- 服務列表可快取（TTL 60~180 秒）。
- API timeout 建議：讀取 3 秒、交易 8 秒、回調 10 秒。
- 關鍵交易需可重試（idempotency + 狀態檢核）。

### 3.7 設計追蹤矩陣（SD-RTM）

| FR | 模組 | 主要 API | 主要資料表 |
|---|---|---|---|
| FR-C-001 | Binding | /bindings/request-otp、/bindings/verify | member_bindings、otp_records |
| FR-C-004 | Order | /orders、/orders/{id}/pay-callback | orders、order_items、payment_events |

---

## 4. SA/SD 整合追溯

| 需求 | Use Case | 設計模組 | 關聯 API | 驗收 |
|---|---|---|---|---|
| FR-C-001 | UC-C-01 | Binding | /bindings/request-otp、/bindings/verify | AT-C-01 |
| FR-C-004 | UC-C-02 | Order | /orders、/orders/{id}/pay-callback | AT-C-02 |
| FR-C-007 | UC-C-03 | Ticket | /tickets | （待補） |
