# 全方位智慧貼身照護平台－機構端規格文件

## 1. 文件控管

| 項目 | 內容 |
|---|---|
| 文件名稱 | 全方位智慧貼身照護平台－機構端規格文件 |
| 文件版本 | v1.0 |
| 文件日期 | 2026-02-26 |
| 整理來源 | 需求資料/系統規格文件.md（SA+SD 整併版） |
| 適用範圍 | 2.機構端 前端頁面與 ACT-O 相關 API/資料模型 |

---

## 2. 需求規格（SA）

### 2.1 角色與權責

| 角色代碼 | 角色名稱 | 機構端關聯責任 |
|---|---|---|
| ACT-O | 機構管理者 | 綁定審核、個案查詢、訂單/分潤、公告、通訊、機構內角色 |
| ACT-C | 客戶端使用者 | 發起綁定與下單、提交客服需求 |
| ACT-P | 平台管理者 | 平台治理、客服總控、稽核監管 |

### 2.2 功能需求（FR-O）

- FR-O-001：個案綁定邀請碼管理與審核。
- FR-O-002：個案主檔與服務歷程查詢。
- FR-O-003：訂單與分潤報表查詢。
- FR-O-004：機構公告管理與閱讀統計。
- FR-O-005：機構通訊管理（單聊/群發）。
- FR-O-006：機構管理者與角色管理。

### 2.3 Use Case（機構端）

| UC 編號 | 名稱 | 關聯需求 |
|---|---|---|
| UC-O-01 | 審核個案綁定申請 | FR-O-001 |
| UC-O-02 | 查詢訂單與分潤 | FR-O-003 |

#### UC-O-01 審核個案綁定申請

- 前置：存在待審綁定申請。
- 主流程：檢視申請 → 核准/駁回 → 更新狀態與審核記錄 → 通知申請者。
- 例外：資料不足要求補件。
- 後置：狀態由 `pending` 轉為 `approved` 或 `rejected`。

### 2.4 業務規則（機構端關聯）

- BR-ORD-001：訂單金額以建立當下快照為準。
- BR-ORD-002：`processing` 訂單不可由客戶端直接取消。
- BR-ORD-003：退款需平台端審核。
- BR-TIC-001：客服單必須具優先級。
- BR-AUD-001：管理端 C/U/D 操作必寫日誌。

### 2.5 狀態模型（機構端關聯）

#### 訂單狀態

`pending_payment` → `paid` → `processing` → `completed`，並支援 `refund_pending` → `refunded` 或回復履約狀態。

#### 綁定申請狀態

`pending` / `approved` / `rejected` / `expired`

### 2.6 權限摘要（ACT-O）

| 模組 | 權限 |
|---|---|
| 個案綁定 | R（審核） |
| 服務與購物車 | R |
| 訂單管理 | R（所屬機構） |
| 公告 | C/R/U/D（機構） |
| 通訊 | C/R/U |
| 客服單 | C/R |
| 角色權限 | C/R/U（機構內） |
| 操作日誌 | R（機構範圍） |

### 2.7 非功能需求（機構端關聯）

- NFR-001：列表 API P95 < 2 秒。
- NFR-010：管理端 RBAC 權限檢核。
- NFR-012：重要操作全量記錄於 audit_log。
- NFR-020：支援桌機與手機版。

### 2.8 驗收條件（AT-O）

- AT-O-01：可完成綁定申請核准/駁回並留下審核紀錄。
- AT-O-02：可依日期與狀態篩選訂單並檢視分潤明細。

### 2.9 頁面盤點（機構端）

- index.html
- members.html
- member-binding.html
- member-review.html
- orders.html
- announcements.html
- chat.html
- admins.html
- organization.html

---

## 3. 系統設計（SD）

### 3.1 設計目標

1. 讓機構端可穩定完成審核、查詢與營運管理。
2. 與客戶端交易資料保持一致並支援分潤追蹤。
3. 機構管理操作具授權檢核與稽核追溯。

### 3.2 架構定位

- Presentation：2.機構端
- API Layer：`/api/v1` + JWT + RBAC
- Domain Services：Binding、Order、Announcement、Messaging、Identity & Access
- Data：MySQL 8

### 3.3 模組設計（機構端主關聯）

| 模組 | 職責 | 主要資料表 |
|---|---|---|
| Binding | 綁定審核流程 | member_bindings、otp_records |
| Order | 訂單/分潤查詢、履約追蹤 | orders、order_items、order_status_logs |
| Announcement/Messaging | 機構公告與通訊 | announcements、chat_rooms、messages |
| Identity & Access | 機構管理角色授權 | roles、permissions、user_roles、role_permissions |

### 3.4 API 規格（機構端）

#### 共通規範

- Base URL：`/api/v1`
- 認證：Bearer JWT
- 格式：application/json
- 追蹤：x-request-id

#### 核心 API

| API | 方法 | 權限 | 用途 |
|---|---|---|---|
| /api/v1/member-bindings/{id}/review | PATCH | ACT-O | 審核綁定申請 |
| /api/v1/orders | GET | ACT-C/ACT-O/ACT-P | 查詢訂單列表 |
| /api/v1/tickets | POST | ACT-C/ACT-O | 建立客服單 |

### 3.5 關鍵流程序列

#### 綁定審核流程（UC-O-01）

1. 客戶端完成綁定申請。
2. 機構端執行 approve/reject。
3. 系統更新 member_bindings 並記錄 reviewer/reviewed_at。
4. 通知申請者審核結果。

#### 訂單履約關聯流程（UC-C-02 / UC-O-02）

1. 客戶端建立訂單並付款。
2. 機構端查詢 paid 訂單並追蹤履約。
3. 狀態推進至 processing/completed。
4. 轉移記錄寫入 order_status_logs。

### 3.6 非功能設計（實作向）

- 訂單查詢需分頁與索引優化。
- 管理端操作需 RBAC 檢核與 audit_logs 留痕。
- 外部服務異常採降級策略（先記錄、後補償）。

### 3.7 設計追蹤矩陣（SD-RTM）

| FR | 模組 | 主要 API | 主要資料表 |
|---|---|---|---|
| FR-O-001 | Binding | /member-bindings/{id}/review | member_bindings、audit_logs |
| FR-O-003 | Order | /orders | orders、order_items |

---

## 4. SA/SD 整合追溯

| 需求 | Use Case | 設計模組 | 關聯 API | 驗收 |
|---|---|---|---|---|
| FR-O-001 | UC-O-01 | Binding | /member-bindings/{id}/review | AT-O-01 |
| FR-O-003 | UC-O-02 | Order | /orders | AT-O-02 |
| FR-O-006 | （待補） | Identity & Access | （待補） | （待補） |
